"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[6448],{6687:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"backend/databases/Modulo24_Consultas_parametrizadas_y_seguridad","title":"Modulo 24. Consultas parametrizadas y seguridad","description":"\ud83e\udded 24.1. Qu\xe9 es la inyecci\xf3n SQL","source":"@site/docs/backend/databases/Modulo24_Consultas_parametrizadas_y_seguridad.md","sourceDirName":"backend/databases","slug":"/backend/databases/Modulo24_Consultas_parametrizadas_y_seguridad","permalink":"/docuQuest/docs/backend/databases/Modulo24_Consultas_parametrizadas_y_seguridad","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/databases/Modulo24_Consultas_parametrizadas_y_seguridad.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Modulo 23. Datos sensibles y auditor\xeda","permalink":"/docuQuest/docs/backend/databases/Modulo23_Datos_sensibles_y_auditoria"},"next":{"title":"Modulo 25. Capas de acceso a datos","permalink":"/docuQuest/docs/backend/databases/Modulo25_Capas_de_acceso_a_datos"}}');var a=s(4848),o=s(8453);const i={},l="Modulo 24. Consultas parametrizadas y seguridad",c={},d=[{value:"\ud83e\udded 24.1. Qu\xe9 es la inyecci\xf3n SQL",id:"-241-qu\xe9-es-la-inyecci\xf3n-sql",level:2},{value:"\ud83e\udde0 24.2. Consultas parametrizadas \u2014 la soluci\xf3n correcta \u2705",id:"-242-consultas-parametrizadas--la-soluci\xf3n-correcta-",level:2},{value:"\ud83e\udded 24.3. Ejemplo en PostgreSQL (par\xe1metros numerados)",id:"-243-ejemplo-en-postgresql-par\xe1metros-numerados",level:2},{value:"\ud83e\udde0 24.4. Paginaci\xf3n correcta \u2014 evitando abusos y ataques",id:"-244-paginaci\xf3n-correcta--evitando-abusos-y-ataques",level:2},{value:"\ud83e\udded 24.5. Filtros din\xe1micos seguros",id:"-245-filtros-din\xe1micos-seguros",level:2},{value:"\ud83e\udde0 24.6. Ordenaci\xf3n predecible y segura",id:"-246-ordenaci\xf3n-predecible-y-segura",level:2},{value:"\ud83e\udded 24.7. Consultas parametrizadas en joins",id:"-247-consultas-parametrizadas-en-joins",level:2},{value:"\ud83e\udde0 24.8. Buenas pr\xe1cticas de seguridad en consultas",id:"-248-buenas-pr\xe1cticas-de-seguridad-en-consultas",level:2},{value:"\ud83d\udea8 24.9. Errores comunes",id:"-249-errores-comunes",level:2}];function t(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"modulo-24-consultas-parametrizadas-y-seguridad",children:"Modulo 24. Consultas parametrizadas y seguridad"})}),"\n",(0,a.jsx)(n.h2,{id:"-241-qu\xe9-es-la-inyecci\xf3n-sql",children:"\ud83e\udded 24.1. Qu\xe9 es la inyecci\xf3n SQL"}),"\n",(0,a.jsxs)(n.p,{children:["La ",(0,a.jsx)(n.strong,{children:"inyecci\xf3n SQL"})," ocurre cuando los datos introducidos por el usuario se ",(0,a.jsx)(n.strong,{children:"insertan directamente"})," en una consulta sin validarlos ni parametrizarlos."]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo inseguro \u274c (muy com\xfan):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"// Supongamos que el usuario escribe su nombre\nconst nombre = req.query.nombre;\n\nconst sql = `SELECT * FROM usuarios WHERE nombre = '${nombre}'`;\ndb.query(sql);\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Si el usuario pone:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"Ana\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 La consulta ser\xe1:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM usuarios WHERE nombre = 'Ana';\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Pero si pone:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"' OR '1'='1\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Se convierte en:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM usuarios WHERE nombre = '' OR '1'='1';\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc49 Resultado: ",(0,a.jsx)(n.strong,{children:"devuelve todos los usuarios"}),", sin autorizaci\xf3n."]}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udccc La inyecci\xf3n SQL es una de las ",(0,a.jsx)(n.strong,{children:"vulnerabilidades m\xe1s frecuentes y peligrosas"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Permite:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Leer datos sensibles,"}),"\n",(0,a.jsx)(n.li,{children:"Modificar registros,"}),"\n",(0,a.jsxs)(n.li,{children:["Borrar tablas completas (",(0,a.jsx)(n.code,{children:"DROP"}),"),"]}),"\n",(0,a.jsx)(n.li,{children:"Incluso ejecutar funciones internas."}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"-242-consultas-parametrizadas--la-soluci\xf3n-correcta-",children:"\ud83e\udde0 24.2. Consultas parametrizadas \u2014 la soluci\xf3n correcta \u2705"}),"\n",(0,a.jsxs)(n.p,{children:["En lugar de insertar valores manualmente en la cadena SQL, se usan ",(0,a.jsx)(n.strong,{children:"placeholders"})," y ",(0,a.jsx)(n.strong,{children:"par\xe1metros separados"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo seguro:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const nombre = req.query.nombre;\n\nconst sql = `SELECT * FROM usuarios WHERE nombre = ?`;\ndb.query(sql, [nombre]);\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc49 El valor de ",(0,a.jsx)(n.code,{children:"nombre"})," no se concatena directamente."]}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc49 El motor lo trata como ",(0,a.jsx)(n.strong,{children:"dato literal"}),", no como c\xf3digo."]}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 No importa qu\xe9 texto meta el usuario: nunca podr\xe1 romper la consulta."}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udccc Esto es v\xe1lido en casi todos los lenguajes modernos:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"?"})," en SQLite, MySQL y muchos ORMs."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"$1"}),", ",(0,a.jsx)(n.code,{children:"$2"}),"\u2026 en PostgreSQL."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"@param"})," en algunos motores."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"-243-ejemplo-en-postgresql-par\xe1metros-numerados",children:"\ud83e\udded 24.3. Ejemplo en PostgreSQL (par\xe1metros numerados)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const correo = req.body.correo;\nconst sql = 'SELECT * FROM usuario WHERE correo = $1';\ndb.query(sql, [correo]);\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Incluso si el usuario escribe:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"' OR 1=1; DROP TABLE usuario;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 la consulta no se rompe."}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 la BD busca literalmente un correo que contenga ese texto (sin \xe9xito)."}),"\n",(0,a.jsx)(n.h2,{id:"-244-paginaci\xf3n-correcta--evitando-abusos-y-ataques",children:"\ud83e\udde0 24.4. Paginaci\xf3n correcta \u2014 evitando abusos y ataques"}),"\n",(0,a.jsxs)(n.p,{children:["Otro error com\xfan es construir ",(0,a.jsx)(n.strong,{children:"paginaci\xf3n insegura"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo inseguro \u274c:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const page = req.query.page;\nconst limit = req.query.limit;\nconst sql = `SELECT * FROM productos LIMIT ${limit} OFFSET ${(page - 1) * limit}`;\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc49 Un atacante puede enviar ",(0,a.jsx)(n.code,{children:"limit=1000000"})," y tumbar la base con una consulta enorme."]}),"\n",(0,a.jsx)(n.p,{children:"\u2705 Soluci\xf3n:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Validar tipos y l\xedmites m\xe1ximos."}),"\n",(0,a.jsx)(n.li,{children:"Usar par\xe1metros, no concatenaci\xf3n."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const page = Math.max(1, parseInt(req.query.page) || 1);\nconst limit = Math.min(50, parseInt(req.query.limit) || 10);\nconst offset = (page - 1) * limit;\n\nconst sql = `SELECT * FROM productos LIMIT $1 OFFSET $2`;\ndb.query(sql, [limit, offset]);\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\ud83d\udc49 La paginaci\xf3n ahora es ",(0,a.jsx)(n.strong,{children:"segura y predecible"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Nadie puede romper la consulta enviando valores raros."}),"\n",(0,a.jsx)(n.h2,{id:"-245-filtros-din\xe1micos-seguros",children:"\ud83e\udded 24.5. Filtros din\xe1micos seguros"}),"\n",(0,a.jsx)(n.p,{children:"Es habitual que las apps tengan filtros din\xe1micos:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Buscar por nombre, categor\xeda, rango de precios, etc."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Error cl\xe1sico \u274c:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"let where = '';\nif (req.query.nombre) {\n  where += ` AND nombre LIKE '%${req.query.nombre}%'`;\n}\nconst sql = `SELECT * FROM productos WHERE 1=1 ${where}`;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Esto es terreno f\xe9rtil para inyecciones."}),"\n",(0,a.jsx)(n.p,{children:"\u2705 Soluci\xf3n:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Construir condiciones din\xe1micas ",(0,a.jsx)(n.strong,{children:"con par\xe1metros separados"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"Usar arrays para los valores."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"let conditions = [];\nlet params = [];\n\nif (req.query.nombre) {\n  params.push(`%${req.query.nombre}%`);\n  conditions.push(`nombre LIKE $${params.length}`);\n}\n\nif (req.query.categoria) {\n  params.push(req.query.categoria);\n  conditions.push(`categoria = $${params.length}`);\n}\n\nconst where = conditions.length ? `WHERE ${conditions.join(' AND ')}` : '';\nconst sql = `SELECT * FROM productos ${where}`;\ndb.query(sql, params);\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Da igual lo que meta el usuario, nunca rompe la consulta."}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 La b\xfasqueda es flexible, segura y escalable."}),"\n",(0,a.jsx)(n.h2,{id:"-246-ordenaci\xf3n-predecible-y-segura",children:"\ud83e\udde0 24.6. Ordenaci\xf3n predecible y segura"}),"\n",(0,a.jsxs)(n.p,{children:["Otro punto d\xe9bil: ",(0,a.jsx)(n.code,{children:"ORDER BY"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["La mayor\xeda de motores ",(0,a.jsx)(n.strong,{children:"no permiten usar par\xe1metros directamente en ORDER BY"}),","]}),"\n",(0,a.jsx)(n.p,{children:"por lo que si no se valida, un atacante puede inyectar c\xf3digo."}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo inseguro \u274c:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const orderBy = req.query.orderBy;\nconst sql = `SELECT * FROM productos ORDER BY ${orderBy}`;\n\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Si ",(0,a.jsx)(n.code,{children:"orderBy"})," = ",(0,a.jsx)(n.code,{children:'"precio; DROP TABLE productos;"'})," \u2192 \ud83d\udca5 desastre."]}),"\n",(0,a.jsx)(n.p,{children:"\u2705 Soluci\xf3n:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Usar ",(0,a.jsx)(n.strong,{children:"listas blancas"})," (whitelists) con columnas v\xe1lidas."]}),"\n",(0,a.jsx)(n.li,{children:"Rechazar cualquier otra cosa."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const validColumns = ['precio', 'nombre', 'fecha_creacion'];\nlet orderBy = 'precio'; // por defecto\n\nif (validColumns.includes(req.query.orderBy)) {\n  orderBy = req.query.orderBy;\n}\n\nconst sql = `SELECT * FROM productos ORDER BY ${orderBy} ASC`;\ndb.query(sql);\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Solo las columnas v\xe1lidas son aceptadas, el resto es ignorado."}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Sin concatenaciones directas con valores arbitrarios."}),"\n",(0,a.jsx)(n.h2,{id:"-247-consultas-parametrizadas-en-joins",children:"\ud83e\udded 24.7. Consultas parametrizadas en joins"}),"\n",(0,a.jsx)(n.p,{children:"Incluso en consultas m\xe1s complejas (con joins), el principio es el mismo:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",children:"const clienteId = req.params.id;\nconst sql = `\n  SELECT p.id, p.total, c.nombre\n  FROM pedido p\n  JOIN cliente c ON p.cliente_id = c.id\n  WHERE c.id = $1\n`;\ndb.query(sql, [clienteId]);\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\ud83d\udc49 Seguro, limpio y mantenible."}),"\n",(0,a.jsx)(n.h2,{id:"-248-buenas-pr\xe1cticas-de-seguridad-en-consultas",children:"\ud83e\udde0 24.8. Buenas pr\xe1cticas de seguridad en consultas"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Nunca concatenes valores del usuario directamente en SQL."}),"\n",(0,a.jsxs)(n.li,{children:["Usa siempre par\xe1metros (",(0,a.jsx)(n.code,{children:"?"}),", ",(0,a.jsx)(n.code,{children:"$1"}),", etc.)."]}),"\n",(0,a.jsxs)(n.li,{children:["Valida y limita paginaci\xf3n (",(0,a.jsx)(n.code,{children:"LIMIT"}),"/",(0,a.jsx)(n.code,{children:"OFFSET"}),")."]}),"\n",(0,a.jsxs)(n.li,{children:["Usa listas blancas para ",(0,a.jsx)(n.code,{children:"ORDER BY"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Construye filtros din\xe1micos ",(0,a.jsx)(n.strong,{children:"con arrays de par\xe1metros"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"Loguea consultas cr\xedticas en la capa de aplicaci\xf3n."}),"\n",(0,a.jsx)(n.li,{children:"Usa roles de BD con privilegios m\xednimos (ver M\xf3dulo 22)."}),"\n",(0,a.jsx)(n.li,{children:"Haz pruebas de inyecci\xf3n de forma proactiva."}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"-249-errores-comunes",children:"\ud83d\udea8 24.9. Errores comunes"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u201cSolo concateno porque es m\xe1s r\xe1pido\u201d \ud83d\ude2c"}),"\n",(0,a.jsx)(n.li,{children:"No validar tipos ni l\xedmites."}),"\n",(0,a.jsx)(n.li,{children:"No controlar columnas permitidas en ordenaci\xf3n."}),"\n",(0,a.jsx)(n.li,{children:"No usar par\xe1metros en joins complejos."}),"\n",(0,a.jsx)(n.li,{children:"Confiar ciegamente en datos de formularios."}),"\n",(0,a.jsx)(n.li,{children:"No tener logging ni monitoreo."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>l});var r=s(6540);const a={},o=r.createContext(a);function i(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);