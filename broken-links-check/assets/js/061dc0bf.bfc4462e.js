"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[9211],{1644:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>t,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"backend/JSON/seguridad","title":"Seguridad b\xe1sica y buenas pr\xe1cticas","description":"Objetivo","source":"@site/docs/backend/JSON/seguridad.md","sourceDirName":"backend/JSON","slug":"/backend/JSON/seguridad","permalink":"/docuQuest/docs/backend/JSON/seguridad","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/JSON/seguridad.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Paginaci\xf3n, filtros, orden de b\xfasqueda en API usuarios","permalink":"/docuQuest/docs/backend/JSON/paginacion"},"next":{"title":"Exportar e importar JSON","permalink":"/docuQuest/docs/backend/JSON/exportarImportar"}}');var a=n(4848),i=n(8453);const o={},t="Seguridad b\xe1sica y buenas pr\xe1cticas",d={},c=[{value:"Objetivo",id:"objetivo",level:2},{value:"1) Cambios en <code>server.js</code>",id:"1-cambios-en-serverjs",level:2},{value:"1.1 Constantes y utilidades (arriba del archivo)",id:"11-constantes-y-utilidades-arriba-del-archivo",level:3},{value:"1.2 <code>sendJson</code> y <code>OPTIONS</code> (a\xf1ade seguridad y CORS)",id:"12-sendjson-y-options-a\xf1ade-seguridad-y-cors",level:3},{value:"1.3 L\xedmite de tama\xf1o y parseo seguro del body",id:"13-l\xedmite-de-tama\xf1o-y-parseo-seguro-del-body",level:3},{value:"1.4 Aplica CORS, rate-limit y cabeceras de seguridad por petici\xf3n",id:"14-aplica-cors-rate-limit-y-cabeceras-de-seguridad-por-petici\xf3n",level:3},{value:"1.5 Endpoints POST y PUT con whitelist y saneado",id:"15-endpoints-post-y-put-con-whitelist-y-saneado",level:3},{value:"2) Ajustes menores en <code>lib/validate.js</code>",id:"2-ajustes-menores-en-libvalidatejs",level:2},{value:"3) (Opcional) L\xedmite de tama\xf1o del archivo JSON",id:"3-opcional-l\xedmite-de-tama\xf1o-del-archivo-json",level:2},{value:"4) Resumen de defensas a\xf1adidas",id:"4-resumen-de-defensas-a\xf1adidas",level:2},{value:"Qu\xe9 no hace (a prop\xf3sito)",id:"qu\xe9-no-hace-a-prop\xf3sito",level:2}];function l(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.header,{children:(0,a.jsx)(r.h1,{id:"seguridad-b\xe1sica-y-buenas-pr\xe1cticas",children:"Seguridad b\xe1sica y buenas pr\xe1cticas"})}),"\n",(0,a.jsx)(r.h2,{id:"objetivo",children:"Objetivo"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"Rechazar bodies demasiado grandes."}),"\n",(0,a.jsxs)(r.li,{children:["Aceptar solo ",(0,a.jsx)(r.code,{children:"Content-Type: application/json"})," donde toca."]}),"\n",(0,a.jsxs)(r.li,{children:["Validar y ",(0,a.jsx)(r.strong,{children:"whitelist"})," de campos (POST/PUT)."]}),"\n",(0,a.jsx)(r.li,{children:"Saneado de strings y control de claves peligrosas."}),"\n",(0,a.jsx)(r.li,{children:"CORS razonable y cabeceras de seguridad."}),"\n",(0,a.jsx)(r.li,{children:"Rate-limit m\xednimo en memoria."}),"\n",(0,a.jsx)(r.li,{children:"(Opcional) l\xedmites sobre el archivo JSON."}),"\n"]}),"\n",(0,a.jsxs)(r.blockquote,{children:["\n",(0,a.jsx)(r.p,{children:"Mantiene la API y el cliente previos sin romperlos."}),"\n"]}),"\n",(0,a.jsxs)(r.h2,{id:"1-cambios-en-serverjs",children:["1) Cambios en ",(0,a.jsx)(r.code,{children:"server.js"})]}),"\n",(0,a.jsx)(r.h3,{id:"11-constantes-y-utilidades-arriba-del-archivo",children:"1.1 Constantes y utilidades (arriba del archivo)"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'const PORT = 3000;\r\n\r\n// Seguridad: l\xedmites y CORS\r\nconst MAX_BODY_BYTES = 10 * 1024; // 10KB por petici\xf3n JSON\r\nconst ALLOWED_ORIGINS = new Set([\r\n  "http://localhost:3000",\r\n  "http://127.0.0.1:3000",\r\n  "http://localhost:5500", // por si sirves el cliente est\xe1tico\r\n  "http://127.0.0.1:5500",\r\n]);\r\n\r\n// Rate limit simple (p. ej., 60 req/min por IP)\r\nconst RATE_LIMIT_WINDOW_MS = 60_000;\r\nconst RATE_LIMIT_MAX = 60;\r\nconst rateMap = new Map(); // ip -> {count, start}\r\n\r\n// Helpers CORS y cabeceras de seguridad\r\nfunction applySecurityHeaders(res) {\r\n  res.setHeader("X-Content-Type-Options", "nosniff");\r\n  res.setHeader("Referrer-Policy", "no-referrer");\r\n  // Como es una API, un CSP simple de \u201cnada por defecto\u201d\r\n  res.setHeader("Content-Security-Policy", "default-src \'none\'");\r\n}\r\n\r\nfunction allowCors(req, res) {\r\n  const origin = req.headers.origin;\r\n  if (origin && ALLOWED_ORIGINS.has(origin)) {\r\n    res.setHeader("Access-Control-Allow-Origin", origin);\r\n  }\r\n  res.setHeader("Vary", "Origin");\r\n  res.setHeader("Access-Control-Allow-Methods", "GET,POST,PUT,DELETE,OPTIONS");\r\n  res.setHeader("Access-Control-Allow-Headers", "Content-Type");\r\n}\r\n\r\n// Rate limit naive por IP\r\nfunction checkRateLimit(req, res) {\r\n  const ip = req.socket.remoteAddress || "unknown";\r\n  const now = Date.now();\r\n  const entry = rateMap.get(ip) || { count: 0, start: now };\r\n  if (now - entry.start > RATE_LIMIT_WINDOW_MS) {\r\n    // reinicia ventana\r\n    entry.count = 0;\r\n    entry.start = now;\r\n  }\r\n  entry.count += 1;\r\n  rateMap.set(ip, entry);\r\n  if (entry.count > RATE_LIMIT_MAX) {\r\n    return false; // bloqueado\r\n  }\r\n  return true;\r\n}\r\n\r\n// Whitelist de campos permitidos en POST/PUT\r\nconst ALLOWED_FIELDS = new Set(["nombre", "email", "edad"]);\r\n\r\n// Saneado y filtros anti-prototype-pollution\r\nfunction isDangerKey(key) {\r\n  return key === "__proto__" || key === "constructor" || key === "prototype";\r\n}\r\nfunction sanitizeString(s) {\r\n  // trim + colapsar espacios + quitar controles no imprimibles b\xe1sicos\r\n  return String(s)\r\n    .trim()\r\n    .replace(/\\s+/g, " ")\r\n    .replace(/[\\u0000-\\u001F\\u007F]/g, "");\r\n}\r\nfunction pickAndSanitizePayload(raw) {\r\n  const out = {};\r\n  for (const [k, v] of Object.entries(raw)) {\r\n    if (isDangerKey(k)) continue; // bloquear claves peligrosas\r\n    if (!ALLOWED_FIELDS.has(k)) continue; // solo campos permitidos\r\n    if (k === "nombre" || k === "email") {\r\n      out[k] = sanitizeString(v);\r\n    } else if (k === "edad") {\r\n      out[k] = Number(v);\r\n    }\r\n  }\r\n  return out;\r\n}\n'})}),"\n",(0,a.jsxs)(r.h3,{id:"12-sendjson-y-options-a\xf1ade-seguridad-y-cors",children:["1.2 ",(0,a.jsx)(r.code,{children:"sendJson"})," y ",(0,a.jsx)(r.code,{children:"OPTIONS"})," (a\xf1ade seguridad y CORS)"]}),"\n",(0,a.jsxs)(r.p,{children:["En tu ",(0,a.jsx)(r.code,{children:"sendJson"}),", antes de ",(0,a.jsx)(r.code,{children:"res.end"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'function sendJson(res, status, payload) {\r\n  const body = JSON.stringify(payload);\r\n  applySecurityHeaders(res);\r\n  // CORS se aplica en cada ruta con allowCors(req,res) antes de llamar a sendJson\r\n  res.writeHead(status, {\r\n    "Content-Type": "application/json; charset=utf-8",\r\n    "Content-Length": Buffer.byteLength(body),\r\n  });\r\n  res.end(body);\r\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:["En el handler de ",(0,a.jsx)(r.code,{children:"OPTIONS"})," (pre-flight), a\xf1ade:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'if (method === "OPTIONS") {\r\n  applySecurityHeaders(res);\r\n  allowCors(req, res);\r\n  res.writeHead(204);\r\n  return res.end();\r\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"13-l\xedmite-de-tama\xf1o-y-parseo-seguro-del-body",children:"1.3 L\xedmite de tama\xf1o y parseo seguro del body"}),"\n",(0,a.jsxs)(r.p,{children:["Reemplaza tu ",(0,a.jsx)(r.code,{children:"parseJsonBody"})," por esta versi\xf3n con l\xedmite de bytes y tipo:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'async function parseJsonBody(req) {\r\n  const ct = req.headers["content-type"] || "";\r\n  if (!/^application\\/json\\b/i.test(ct)) {\r\n    throw new Error("Content-Type debe ser application/json");\r\n  }\r\n  const chunks = [];\r\n  let total = 0;\r\n  for await (const chunk of req) {\r\n    total += chunk.length;\r\n    if (total > MAX_BODY_BYTES) {\r\n      throw new Error("Body demasiado grande");\r\n    }\r\n    chunks.push(chunk);\r\n  }\r\n  const raw = Buffer.concat(chunks).toString("utf8");\r\n  if (!raw.trim()) return {};\r\n  try {\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    throw new Error("JSON inv\xe1lido");\r\n  }\r\n}\n'})}),"\n",(0,a.jsx)(r.h3,{id:"14-aplica-cors-rate-limit-y-cabeceras-de-seguridad-por-petici\xf3n",children:"1.4 Aplica CORS, rate-limit y cabeceras de seguridad por petici\xf3n"}),"\n",(0,a.jsxs)(r.p,{children:["Justo al entrar al ",(0,a.jsx)(r.code,{children:"createServer"})," (antes del router):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'const server = http.createServer(async (req, res) => {\r\n  try {\r\n    applySecurityHeaders(res);\r\n    allowCors(req, res);\r\n\r\n    if (!checkRateLimit(req, res)) {\r\n      return sendJson(res, 429, { error: "Demasiadas peticiones" });\r\n    }\r\n\r\n    const url = new URL(req.url, `http://${req.headers.host}`);\r\n    const method = req.method || "GET";\r\n    // ...\r\n\n'})}),"\n",(0,a.jsx)(r.h3,{id:"15-endpoints-post-y-put-con-whitelist-y-saneado",children:"1.5 Endpoints POST y PUT con whitelist y saneado"}),"\n",(0,a.jsxs)(r.p,{children:["En ",(0,a.jsx)(r.strong,{children:"POST /api/usuarios"})," (sustituye la parte donde usas ",(0,a.jsx)(r.code,{children:"payload"}),"):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'if (method === "POST" && url.pathname === "/api/usuarios") {\r\n  try {\r\n    const raw = await parseJsonBody(req);\r\n    const payload = pickAndSanitizePayload(raw); // \u2190 whitelist + saneado\r\n    validarUsuarioNuevo(payload); // \u2190 reglas del M\xf3dulo 10\r\n    const usuarios = await readJsonArray();\r\n    asegurarEmailUnico(usuarios, payload.email);\r\n\r\n    const nextId = usuarios.length\r\n      ? Math.max(...usuarios.map((u) => u.id || 0)) + 1\r\n      : 1;\r\n\r\n    const nuevo = {\r\n      id: nextId,\r\n      nombre: payload.nombre,\r\n      email: payload.email,\r\n      edad: payload.edad,\r\n      fecha: new Date().toISOString().replace("T", " ").slice(0, 16),\r\n    };\r\n\r\n    usuarios.push(nuevo);\r\n    await writeJsonArray(usuarios);\r\n    return sendJson(res, 201, nuevo);\r\n  } catch (e) {\r\n    return sendJson(res, 400, { error: e.message });\r\n  }\r\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:["En ",(0,a.jsxs)(r.strong,{children:["PUT /api/usuarios/",":id"]})," (sustituye donde montas ",(0,a.jsx)(r.code,{children:"patch"}),"):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'if (method === "PUT" && url.pathname.startsWith("/api/usuarios/")) {\r\n  const id = Number(url.pathname.split("/").pop());\r\n  if (Number.isNaN(id)) return sendJson(res, 400, { error: "id inv\xe1lido" });\r\n\r\n  let patchRaw;\r\n  try {\r\n    patchRaw = await parseJsonBody(req);\r\n  } catch (e) {\r\n    return sendJson(res, 400, { error: e.message });\r\n  }\r\n\r\n  const patch = pickAndSanitizePayload(patchRaw); // \u2190 whitelist+saneado\r\n  try {\r\n    validarUsuarioPatch(patch);\r\n  } catch (e) {\r\n    return sendJson(res, 400, { error: e.message });\r\n  }\r\n\r\n  const usuarios = await readJsonArray();\r\n  const idx = usuarios.findIndex((u) => u.id === id);\r\n  if (idx === -1) return sendJson(res, 404, { error: "No encontrado" });\r\n\r\n  if (patch.email) {\r\n    try {\r\n      asegurarEmailUnico(usuarios, patch.email, id);\r\n    } catch (e) {\r\n      return sendJson(res, 400, { error: e.message });\r\n    }\r\n  }\r\n\r\n  usuarios[idx] = { ...usuarios[idx], ...patch };\r\n  await writeJsonArray(usuarios);\r\n  return sendJson(res, 200, usuarios[idx]);\r\n}\n'})}),"\n",(0,a.jsxs)(r.blockquote,{children:["\n",(0,a.jsx)(r.p,{children:"GET y DELETE no requieren cambios relevantes para seguridad b\xe1sica, m\xe1s all\xe1 de CORS, rate-limit y cabeceras."}),"\n"]}),"\n",(0,a.jsxs)(r.h2,{id:"2-ajustes-menores-en-libvalidatejs",children:["2) Ajustes menores en ",(0,a.jsx)(r.code,{children:"lib/validate.js"})]}),"\n",(0,a.jsx)(r.p,{children:"Refuerza reglas para que el saneado + validaci\xf3n se den la mano:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'// validarUsuarioNuevo(data)\r\nif (data.nombre.length < 2) {\r\n  throw new Error("Nombre demasiado corto.");\r\n}\r\nif (!/^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$/.test(data.email)) {\r\n  throw new Error("Email inv\xe1lido.");\r\n}\r\nif (!Number.isInteger(data.edad) || data.edad < 0 || data.edad > 120) {\r\n  throw new Error("Edad inv\xe1lida (0-120).");\r\n}\r\n\r\n// validarUsuarioPatch(patch)\r\nif ("nombre" in patch && patch.nombre.length < 2) {\r\n  throw new Error("Nombre demasiado corto en patch.");\r\n}\r\nif ("email" in patch && !/^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$/.test(patch.email)) {\r\n  throw new Error("Email inv\xe1lido en patch.");\r\n}\r\nif (\r\n  "edad" in patch &&\r\n  (!Number.isInteger(patch.edad) || patch.edad < 0 || patch.edad > 120)\r\n) {\r\n  throw new Error("Edad inv\xe1lida en patch (0-120).");\r\n}\n'})}),"\n",(0,a.jsx)(r.h2,{id:"3-opcional-l\xedmite-de-tama\xf1o-del-archivo-json",children:"3) (Opcional) L\xedmite de tama\xf1o del archivo JSON"}),"\n",(0,a.jsxs)(r.p,{children:["En ",(0,a.jsx)(r.code,{children:"lib/file-utils.js"}),", antes de leer, puedes rechazar archivos descomunales:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-jsx",children:'import { stat } from "node:fs/promises";\r\nconst MAX_JSON_FILE_BYTES = 5 * 1024 * 1024; // 5MB\r\n\r\nexport async function readJsonArray(filePath = DATA_PATH) {\r\n  if (!(await exists(filePath))) return [];\r\n  try {\r\n    const s = await stat(filePath);\r\n    if (s.size > MAX_JSON_FILE_BYTES) {\r\n      // Evita cargar archivos desorbitados\r\n      return [];\r\n    }\r\n  } catch {}\r\n  // ... resto igual\r\n}\n'})}),"\n",(0,a.jsx)(r.h2,{id:"4-resumen-de-defensas-a\xf1adidas",children:"4) Resumen de defensas a\xf1adidas"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Tama\xf1o de body"}),": corta peticiones > 10KB."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Content-Type"}),": exige ",(0,a.jsx)(r.code,{children:"application/json"})," en POST/PUT."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Whitelist + saneado"}),": solo ",(0,a.jsx)(r.code,{children:"nombre"}),", ",(0,a.jsx)(r.code,{children:"email"}),", ",(0,a.jsx)(r.code,{children:"edad"}),", limpiando strings."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Claves peligrosas"}),": bloqueadas ",(0,a.jsx)(r.code,{children:"__proto__"}),", ",(0,a.jsx)(r.code,{children:"constructor"}),", ",(0,a.jsx)(r.code,{children:"prototype"}),"."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Validaci\xf3n"}),": tipos, rango, formato de email, unicidad."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Rate-limit"}),": 60 peticiones/min por IP (en memoria)."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"CORS"}),": solo or\xedgenes permitidos; expone cabeceras cuando hace falta."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Cabeceras de seguridad"}),": ",(0,a.jsx)(r.code,{children:"X-Content-Type-Options"}),", ",(0,a.jsx)(r.code,{children:"Referrer-Policy"}),", ",(0,a.jsx)(r.code,{children:"CSP"})," m\xednimo."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"(Opc.) L\xedmite de tama\xf1o del .json"})," para evitar lecturas enormes."]}),"\n"]}),"\n",(0,a.jsx)(r.h2,{id:"qu\xe9-no-hace-a-prop\xf3sito",children:"Qu\xe9 no hace (a prop\xf3sito)"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"No cifra ni autentica: eso ser\xeda otro bloque (auth, tokens, sesiones)."}),"\n",(0,a.jsx)(r.li,{children:"No persiste rate-limit entre reinicios (en memoria es suficiente para clase)."}),"\n",(0,a.jsx)(r.li,{children:"No registra auditor\xeda; puedes a\xf1adir logs si lo necesitas."}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>o,x:()=>t});var s=n(6540);const a={},i=s.createContext(a);function o(e){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:r},e.children)}}}]);