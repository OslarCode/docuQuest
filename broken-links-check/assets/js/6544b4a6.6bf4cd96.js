"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[8031],{4550:(r,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"backend/JSON/validacionControlErrores","title":"Validaci\xf3n y control de errores con JSON","description":"Objetivo","source":"@site/docs/backend/JSON/validacionControlErrores.md","sourceDirName":"backend/JSON","slug":"/backend/JSON/validacionControlErrores","permalink":"/docuQuest/docs/backend/JSON/validacionControlErrores","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/JSON/validacionControlErrores.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Actualizar y eliminar datos en archivos JSON con Node.js","permalink":"/docuQuest/docs/backend/JSON/actualizarEliminar"},"next":{"title":"CRUD HTTP nativo con Node.js","permalink":"/docuQuest/docs/backend/JSON/crud"}}');var i=n(4848),s=n(8453);const o={},t="Validaci\xf3n y control de errores con JSON",c={},l=[{value:"Objetivo",id:"objetivo",level:2},{value:"Estructura propuesta",id:"estructura-propuesta",level:2},{value:"<code>lib/validate.js</code> \u2014 Reglas de validaci\xf3n",id:"libvalidatejs--reglas-de-validaci\xf3n",level:2},{value:"<code>lib/file-utils.js</code> \u2014 Lectura/escritura robusta",id:"libfile-utilsjs--lecturaescritura-robusta",level:2},{value:"<code>create.js</code> \u2014 Crear con validaci\xf3n y unicidad de email",id:"createjs--crear-con-validaci\xf3n-y-unicidad-de-email",level:2},{value:"<code>update.js</code> \u2014 Actualizaci\xf3n parcial con validaci\xf3n de patch",id:"updatejs--actualizaci\xf3n-parcial-con-validaci\xf3n-de-patch",level:2},{value:"<code>delete.js</code> \u2014 Eliminar con chequeos m\xednimos",id:"deletejs--eliminar-con-chequeos-m\xednimos",level:2},{value:"Pruebas manuales r\xe1pidas",id:"pruebas-manuales-r\xe1pidas",level:2},{value:"Errores t\xedpicos y c\xf3mo se gestionan",id:"errores-t\xedpicos-y-c\xf3mo-se-gestionan",level:2},{value:"Recomendaciones m\xednimas",id:"recomendaciones-m\xednimas",level:2}];function d(r){const e={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...r.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"validaci\xf3n-y-control-de-errores-con-json",children:"Validaci\xf3n y control de errores con JSON"})}),"\n",(0,i.jsx)(e.h2,{id:"objetivo",children:"Objetivo"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Validar campos y tipos antes de crear o actualizar."}),"\n",(0,i.jsx)(e.li,{children:"Rechazar entradas incompletas o mal formadas."}),"\n",(0,i.jsx)(e.li,{children:"Manejar JSON vac\xedo o corrupto sin romper la app."}),"\n",(0,i.jsx)(e.li,{children:"Escribir el archivo de forma segura."}),"\n",(0,i.jsx)(e.li,{children:"Centralizar reglas de negocio en un \xfanico sitio."}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"estructura-propuesta",children:"Estructura propuesta"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"json-crud/\r\n\u251c\u2500\u2500 data/\r\n\u2502   \u2514\u2500\u2500 usuarios.json\r\n\u251c\u2500\u2500 lib/\r\n\u2502   \u251c\u2500\u2500 file-utils.js      \u2190 lectura/escritura segura\r\n\u2502   \u2514\u2500\u2500 validate.js        \u2190 reglas de validaci\xf3n\r\n\u251c\u2500\u2500 create.js              \u2190 crear registro con validaci\xf3n\r\n\u251c\u2500\u2500 update.js              \u2190 actualizar con validaci\xf3n parcial\r\n\u251c\u2500\u2500 delete.js\r\n\u2514\u2500\u2500 list.js\r\n\n"})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"Si ya tienes los ficheros del M\xf3dulo 9, solo a\xf1ade validate.js y mejora file-utils.js, create.js y update.js con las validaciones."}),"\n"]}),"\n",(0,i.jsxs)(e.h2,{id:"libvalidatejs--reglas-de-validaci\xf3n",children:[(0,i.jsx)(e.code,{children:"lib/validate.js"})," \u2014 Reglas de validaci\xf3n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-jsx",children:'// lib/validate.js\r\n\r\n// Reglas de negocio m\xednimas. Ajusta seg\xfan tu dominio.\r\nexport function validarUsuarioNuevo(data) {\r\n  // Campos obligatorios\r\n  if (typeof data.nombre !== "string" || !data.nombre.trim()) {\r\n    throw new Error("El nombre es obligatorio y debe ser texto.");\r\n  }\r\n  if (typeof data.email !== "string" || !data.email.includes("@")) {\r\n    throw new Error("Email inv\xe1lido.");\r\n  }\r\n  if (!Number.isInteger(data.edad) || data.edad < 0) {\r\n    throw new Error("Edad inv\xe1lida. Debe ser entero >= 0.");\r\n  }\r\n  return true;\r\n}\r\n\r\n// Validaci\xf3n parcial para updates. Solo valida lo que venga en \'patch\'.\r\nexport function validarUsuarioPatch(patch) {\r\n  if ("nombre" in patch) {\r\n    if (typeof patch.nombre !== "string" || !patch.nombre.trim()) {\r\n      throw new Error("Nombre inv\xe1lido en patch.");\r\n    }\r\n  }\r\n  if ("email" in patch) {\r\n    if (typeof patch.email !== "string" || !patch.email.includes("@")) {\r\n      throw new Error("Email inv\xe1lido en patch.");\r\n    }\r\n  }\r\n  if ("edad" in patch) {\r\n    if (!Number.isInteger(patch.edad) || patch.edad < 0) {\r\n      throw new Error("Edad inv\xe1lida en patch.");\r\n    }\r\n  }\r\n  return true;\r\n}\r\n\r\n// Utilidad opcional para evitar colisiones de email\r\nexport function asegurarEmailUnico(usuarios, email, idIgnorar = null) {\r\n  const duplicado = usuarios.some(\r\n    (u) => u.email === email && u.id !== idIgnorar\r\n  );\r\n  if (duplicado) {\r\n    throw new Error("Email ya existente.");\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(e.h2,{id:"libfile-utilsjs--lecturaescritura-robusta",children:[(0,i.jsx)(e.code,{children:"lib/file-utils.js"})," \u2014 Lectura/escritura robusta"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-jsx",children:'// lib/file-utils.js\r\nimport { readFile, writeFile, access, rename } from "node:fs/promises";\r\nimport { constants } from "node:fs";\r\nimport path from "node:path";\r\nimport { fileURLToPath } from "node:url";\r\nimport os from "node:os";\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = path.dirname(__filename);\r\nexport const DATA_PATH = path.join(__dirname, "..", "data", "usuarios.json");\r\n\r\n// Comprobar existencia\r\nexport async function exists(p) {\r\n  try {\r\n    await access(p, constants.F_OK);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Lectura segura: si no existe o est\xe1 vac\xedo/corrupto, devuelve []\r\nexport async function readJsonArray(filePath = DATA_PATH) {\r\n  if (!(await exists(filePath))) return [];\r\n  let txt = "";\r\n  try {\r\n    txt = await readFile(filePath, "utf8");\r\n  } catch {\r\n    return [];\r\n  }\r\n  if (!txt.trim()) return [];\r\n  try {\r\n    const data = JSON.parse(txt);\r\n    return Array.isArray(data) ? data : [];\r\n  } catch {\r\n    // JSON corrupto: no reventar; devolver []\r\n    return [];\r\n  }\r\n}\r\n\r\n// Escritura at\xf3mica simple: escribir en tmp y renombrar\r\nexport async function writeJsonArray(arr, filePath = DATA_PATH) {\r\n  const json = JSON.stringify(arr, null, 2);\r\n  const tmpPath = filePath + "." + process.pid + "." + Date.now() + ".tmp";\r\n  await writeFile(tmpPath, json, "utf8");\r\n  await rename(tmpPath, filePath);\r\n}\n'})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"La escritura \u201cat\xf3mica\u201d evita archivos a medias si el proceso se interrumpe. Es suficiente para este nivel."}),"\n"]}),"\n",(0,i.jsxs)(e.h2,{id:"createjs--crear-con-validaci\xf3n-y-unicidad-de-email",children:[(0,i.jsx)(e.code,{children:"create.js"})," \u2014 Crear con validaci\xf3n y unicidad de email"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-jsx",children:'// create.js\r\nimport { readJsonArray, writeJsonArray } from "./lib/file-utils.js";\r\nimport { validarUsuarioNuevo, asegurarEmailUnico } from "./lib/validate.js";\r\n\r\n// Uso: node create.js nombre="Mario" email=mario@mail.com edad=35\r\nfunction parseArgs(argv) {\r\n  const obj = {};\r\n  for (const arg of argv) {\r\n    const i = arg.indexOf("=");\r\n    if (i === -1) continue;\r\n    const k = arg.slice(0, i);\r\n    const v = arg.slice(i + 1);\r\n    if (/^-?\\d+$/.test(v)) obj[k] = Number(v);\r\n    else obj[k] = v;\r\n  }\r\n  return obj;\r\n}\r\n\r\nconst payload = parseArgs(process.argv.slice(2));\r\n\r\ntry {\r\n  validarUsuarioNuevo(payload);\r\n\r\n  const usuarios = await readJsonArray();\r\n  asegurarEmailUnico(usuarios, payload.email);\r\n\r\n  const nextId = usuarios.length\r\n    ? Math.max(...usuarios.map((u) => u.id || 0)) + 1\r\n    : 1;\r\n  const nuevo = {\r\n    id: nextId,\r\n    nombre: payload.nombre.trim(),\r\n    email: payload.email.trim(),\r\n    edad: payload.edad,\r\n    fecha: new Date().toISOString().replace("T", " ").slice(0, 16),\r\n  };\r\n\r\n  usuarios.push(nuevo);\r\n  await writeJsonArray(usuarios);\r\n\r\n  console.log(`Creado id=${nuevo.id}`);\r\n  process.exit(0);\r\n} catch (err) {\r\n  console.error("Error al crear:", err.message);\r\n  process.exit(1);\r\n}\n'})}),"\n",(0,i.jsxs)(e.h2,{id:"updatejs--actualizaci\xf3n-parcial-con-validaci\xf3n-de-patch",children:[(0,i.jsx)(e.code,{children:"update.js"})," \u2014 Actualizaci\xf3n parcial con validaci\xf3n de patch"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-jsx",children:'// update.js\r\nimport { readJsonArray, writeJsonArray } from "./lib/file-utils.js";\r\nimport { validarUsuarioPatch, asegurarEmailUnico } from "./lib/validate.js";\r\n\r\n// Uso: node update.js 3 nombre=Peach email=peach@royal.org edad=29\r\nfunction parseArgsToPatch(argv) {\r\n  const patch = {};\r\n  for (const kv of argv) {\r\n    const i = kv.indexOf("=");\r\n    if (i === -1) continue;\r\n    const key = kv.slice(0, i);\r\n    const raw = kv.slice(i + 1);\r\n    if (/^-?\\d+$/.test(raw)) patch[key] = Number(raw);\r\n    else if (raw === "null") patch[key] = null;\r\n    else if (raw === "true" || raw === "false") patch[key] = raw === "true";\r\n    else patch[key] = raw;\r\n  }\r\n  return patch;\r\n}\r\n\r\nconst [idArg, ...rest] = process.argv.slice(2);\r\nif (!idArg) {\r\n  console.error("Uso: node update.js <id> campo=valor ...");\r\n  process.exit(1);\r\n}\r\n\r\nconst id = Number(idArg);\r\nif (Number.isNaN(id)) {\r\n  console.error("El id debe ser num\xe9rico.");\r\n  process.exit(1);\r\n}\r\n\r\nconst patch = parseArgsToPatch(rest);\r\nif (!Object.keys(patch).length) {\r\n  console.error("Debes indicar al menos un campo=valor.");\r\n  process.exit(1);\r\n}\r\n\r\ntry {\r\n  const usuarios = await readJsonArray();\r\n  const idx = usuarios.findIndex((u) => u.id === id);\r\n  if (idx === -1) throw new Error(`No existe usuario con id ${id}.`);\r\n\r\n  // Validaci\xf3n del patch (solo lo que venga)\r\n  validarUsuarioPatch(patch);\r\n\r\n  // Si se cambia email, asegurar unicidad\r\n  if (patch.email) {\r\n    asegurarEmailUnico(usuarios, patch.email, id);\r\n  }\r\n\r\n  usuarios[idx] = { ...usuarios[idx], ...patch };\r\n  await writeJsonArray(usuarios);\r\n  console.log(`Usuario ${id} actualizado.`);\r\n  process.exit(0);\r\n} catch (err) {\r\n  console.error("Error al actualizar:", err.message);\r\n  process.exit(1);\r\n}\n'})}),"\n",(0,i.jsxs)(e.h2,{id:"deletejs--eliminar-con-chequeos-m\xednimos",children:[(0,i.jsx)(e.code,{children:"delete.js"})," \u2014 Eliminar con chequeos m\xednimos"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-jsx",children:'// delete.js\r\nimport { readJsonArray, writeJsonArray } from "./lib/file-utils.js";\r\n\r\nconst idArg = process.argv[2];\r\nif (!idArg) {\r\n  console.error("Uso: node delete.js <id>");\r\n  process.exit(1);\r\n}\r\n\r\nconst id = Number(idArg);\r\nif (Number.isNaN(id)) {\r\n  console.error("El id debe ser num\xe9rico.");\r\n  process.exit(1);\r\n}\r\n\r\ntry {\r\n  const usuarios = await readJsonArray();\r\n  const existe = usuarios.some((u) => u.id === id);\r\n  if (!existe) throw new Error(`No existe usuario con id ${id}.`);\r\n  const nuevos = usuarios.filter((u) => u.id !== id);\r\n  await writeJsonArray(nuevos);\r\n  console.log(`Usuario ${id} eliminado.`);\r\n  process.exit(0);\r\n} catch (err) {\r\n  console.error("Error al eliminar:", err.message);\r\n  process.exit(1);\r\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"pruebas-manuales-r\xe1pidas",children:"Pruebas manuales r\xe1pidas"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Crear:"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'node create.js nombre="Mario" email=mario@mail.com edad=35\r\nnode create.js nombre="Luigi" email=luigi@mail.com edad=34\r\n\n'})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Duplicado de email (debe fallar):"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'node create.js nombre="Otro" email=mario@mail.com edad=20\r\n\n'})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Update parcial con validaci\xf3n:"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"node update.js 1 email=mario@new.com\r\nnode update.js 2 edad=33\r\n\n"})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Update inv\xe1lido (edad negativa, debe fallar):"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"node update.js 2 edad=-1\r\n\n"})}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Delete:"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"node delete.js 1\r\n\n"})}),"\n",(0,i.jsx)(e.h2,{id:"errores-t\xedpicos-y-c\xf3mo-se-gestionan",children:"Errores t\xedpicos y c\xf3mo se gestionan"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"Problema"}),(0,i.jsx)(e.th,{children:"Comportamiento del m\xf3dulo"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Archivo no existe"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"readJsonArray()"})," devuelve ",(0,i.jsx)(e.code,{children:"[]"}),"."]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Archivo vac\xedo"}),(0,i.jsxs)(e.td,{children:["Devuelve ",(0,i.jsx)(e.code,{children:"[]"}),"."]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Archivo corrupto"}),(0,i.jsxs)(e.td,{children:["Devuelve ",(0,i.jsx)(e.code,{children:"[]"})," sin romper el flujo."]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Faltan campos obligatorios"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"validarUsuarioNuevo()"})," lanza error claro."]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Tipos incorrectos en patch"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"validarUsuarioPatch()"})," lanza error claro."]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Email duplicado"}),(0,i.jsxs)(e.td,{children:[(0,i.jsx)(e.code,{children:"asegurarEmailUnico()"})," lanza error."]})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Escritura interrumpida"}),(0,i.jsx)(e.td,{children:"Escritura at\xf3mica: primero tmp, luego rename."})]})]})]}),"\n",(0,i.jsx)(e.h2,{id:"recomendaciones-m\xednimas",children:"Recomendaciones m\xednimas"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"No guardes datos sensibles en JSON plano."}),"\n",(0,i.jsx)(e.li,{children:"Haz copia de seguridad del archivo si los datos importan."}),"\n",(0,i.jsx)(e.li,{children:"Mant\xe9n mensajes de error claros y consistentes."}),"\n",(0,i.jsx)(e.li,{children:"Si vas a crecer, separa validaciones por contexto (crear vs actualizar) y a\xf1ade m\xe1s reglas."}),"\n"]})]})}function u(r={}){const{wrapper:e}={...(0,s.R)(),...r.components};return e?(0,i.jsx)(e,{...r,children:(0,i.jsx)(d,{...r})}):d(r)}},8453:(r,e,n)=>{n.d(e,{R:()=>o,x:()=>t});var a=n(6540);const i={},s=a.createContext(i);function o(r){const e=a.useContext(s);return a.useMemo(function(){return"function"==typeof r?r(e):{...e,...r}},[e,r])}function t(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(i):r.components||i:o(r.components),a.createElement(s.Provider,{value:e},r.children)}}}]);