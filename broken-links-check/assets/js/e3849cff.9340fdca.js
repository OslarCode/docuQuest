"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[6503],{5999:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"backend/databases/Modulo26_Control_de_cambios_del_esquema","title":"Modulo 26. Control de cambios del esquema","description":"\ud83e\udded 26.1. Por qu\xe9 versionar cambios en la base","source":"@site/docs/backend/databases/Modulo26_Control_de_cambios_del_esquema.md","sourceDirName":"backend/databases","slug":"/backend/databases/Modulo26_Control_de_cambios_del_esquema","permalink":"/docuQuest/docs/backend/databases/Modulo26_Control_de_cambios_del_esquema","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/databases/Modulo26_Control_de_cambios_del_esquema.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Modulo 25. Capas de acceso a datos","permalink":"/docuQuest/docs/backend/databases/Modulo25_Capas_de_acceso_a_datos"},"next":{"title":"Modulo 27. Pruebas de bases de datos","permalink":"/docuQuest/docs/backend/databases/Modulo27_Pruebas_de_bases_de_datos"}}');var i=n(4848),r=n(8453);const o={},c="Modulo 26. Control de cambios del esquema",l={},d=[{value:"\ud83e\udded 26.1. Por qu\xe9 versionar cambios en la base",id:"-261-por-qu\xe9-versionar-cambios-en-la-base",level:2},{value:"\ud83e\udde0 26.2. Qu\xe9 es una migraci\xf3n",id:"-262-qu\xe9-es-una-migraci\xf3n",level:2},{value:"\ud83e\udded 26.3. Migraciones ascendentes y descendentes",id:"-263-migraciones-ascendentes-y-descendentes",level:2},{value:"\ud83e\uddf1 26.4. Ejemplo pr\xe1ctico \u2014 a\xf1adir columna",id:"-264-ejemplo-pr\xe1ctico--a\xf1adir-columna",level:2},{value:"\ud83e\udded 26.5. Herramientas comunes para migraciones",id:"-265-herramientas-comunes-para-migraciones",level:2},{value:"\ud83e\udde0 26.6. Migraciones autom\xe1ticas vs manuales",id:"-266-migraciones-autom\xe1ticas-vs-manuales",level:2},{value:"\ud83e\udded 26.7. Semillas (seeders) \u2014 poblar datos iniciales",id:"-267-semillas-seeders--poblar-datos-iniciales",level:2},{value:"\ud83e\uddf1 26.8. Data-migrations \u2014 cuando cambia la forma de los datos",id:"-268-data-migrations--cuando-cambia-la-forma-de-los-datos",level:2},{value:"\ud83e\udded 26.9. Buenas pr\xe1cticas con migraciones",id:"-269-buenas-pr\xe1cticas-con-migraciones",level:2},{value:"\ud83e\udde0 26.10. Despliegues seguros con migraciones",id:"-2610-despliegues-seguros-con-migraciones",level:2},{value:"\ud83d\udea8 26.11. Errores comunes",id:"-2611-errores-comunes",level:2}];function t(e){const s={code:"code",em:"em",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"modulo-26-control-de-cambios-del-esquema",children:"Modulo 26. Control de cambios del esquema"})}),"\n",(0,i.jsx)(s.h2,{id:"-261-por-qu\xe9-versionar-cambios-en-la-base",children:"\ud83e\udded 26.1. Por qu\xe9 versionar cambios en la base"}),"\n",(0,i.jsx)(s.p,{children:"Cuando desarrollas una aplicaci\xf3n moderna:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"El c\xf3digo est\xe1 versionado en Git,"}),"\n",(0,i.jsx)(s.li,{children:"El frontend evoluciona con commits y ramas,"}),"\n",(0,i.jsx)(s.li,{children:"Pero la base de datos\u2026 \xbfc\xf3mo controlas su evoluci\xf3n?"}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udc49 No puedes depender de \u201ccopiar y pegar scripts SQL a mano\u201d."}),"\n",(0,i.jsx)(s.p,{children:"Si dos desarrolladores hacen cambios en paralelo, sin control:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"La base de datos puede quedar inconsistente."}),"\n",(0,i.jsx)(s.li,{children:"Desplegar a producci\xf3n se vuelve riesgoso."}),"\n",(0,i.jsx)(s.li,{children:"No hay forma de \u201cvolver atr\xe1s\u201d si algo sale mal."}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["\ud83d\udccc Por eso usamos ",(0,i.jsx)(s.strong,{children:"migraciones"}),": scripts ordenados que describen c\xf3mo cambia la base a lo largo del tiempo."]}),"\n",(0,i.jsx)(s.h2,{id:"-262-qu\xe9-es-una-migraci\xf3n",children:"\ud83e\udde0 26.2. Qu\xe9 es una migraci\xf3n"}),"\n",(0,i.jsxs)(s.p,{children:["Una ",(0,i.jsx)(s.strong,{children:"migraci\xf3n"})," es un archivo que contiene instrucciones para ",(0,i.jsx)(s.strong,{children:"modificar la estructura de la base"})," de forma ",(0,i.jsx)(s.strong,{children:"determin\xedstica y reversible"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"Ejemplo \u2014 crear tabla productos:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"-- 001_create_productos_up.sql\nCREATE TABLE productos (\n  id SERIAL PRIMARY KEY,\n  nombre VARCHAR(100) NOT NULL,\n  precio NUMERIC(10,2) NOT NULL,\n  creado_en TIMESTAMP DEFAULT NOW()\n);\n\n"})}),"\n",(0,i.jsx)(s.p,{children:"Y su reverso:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"-- 001_create_productos_down.sql\nDROP TABLE productos;\n\n"})}),"\n",(0,i.jsxs)(s.p,{children:["\ud83d\udccc ",(0,i.jsx)(s.em,{children:"Up = aplicar cambios"})]}),"\n",(0,i.jsxs)(s.p,{children:["\ud83d\udccc ",(0,i.jsx)(s.em,{children:"Down = revertir cambios"})]}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udc49 Con esto puedes:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Crear la tabla en desarrollo, staging y producci\xf3n."}),"\n",(0,i.jsx)(s.li,{children:"Revertir si algo falla."}),"\n",(0,i.jsx)(s.li,{children:"Mantener un historial claro de cambios."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"-263-migraciones-ascendentes-y-descendentes",children:"\ud83e\udded 26.3. Migraciones ascendentes y descendentes"}),"\n",(0,i.jsxs)(s.p,{children:["Las migraciones se ",(0,i.jsx)(s.strong,{children:"aplican en orden"})," (ascendentes) o se ",(0,i.jsx)(s.strong,{children:"deshacen"})," (descendentes)."]}),"\n",(0,i.jsx)(s.p,{children:"Ejemplo:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"001_create_productos.sql\n002_add_stock_column.sql\n003_add_categoria_table.sql\n\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Migrar \u201chacia arriba\u201d \u2192 se aplican en orden 1, 2, 3."}),"\n",(0,i.jsx)(s.li,{children:"Migrar \u201chacia abajo\u201d \u2192 se revierten en orden 3, 2, 1."}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"\u2705 Esto permite sincronizar la estructura de la base con cualquier versi\xf3n del c\xf3digo."}),"\n",(0,i.jsx)(s.h2,{id:"-264-ejemplo-pr\xe1ctico--a\xf1adir-columna",children:"\ud83e\uddf1 26.4. Ejemplo pr\xe1ctico \u2014 a\xf1adir columna"}),"\n",(0,i.jsx)(s.p,{children:"Up:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"ALTER TABLE productos ADD COLUMN stock INT DEFAULT 0;\n\n"})}),"\n",(0,i.jsx)(s.p,{children:"Down:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"ALTER TABLE productos DROP COLUMN stock;\n\n"})}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udc49 Peque\xf1o cambio, pero versionado y reversible."}),"\n",(0,i.jsx)(s.h2,{id:"-265-herramientas-comunes-para-migraciones",children:"\ud83e\udded 26.5. Herramientas comunes para migraciones"}),"\n",(0,i.jsx)(s.p,{children:"Dependiendo del stack, hay varias opciones populares:"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Herramienta"}),(0,i.jsx)(s.th,{children:"Lenguaje"}),(0,i.jsx)(s.th,{children:"Descripci\xf3n breve"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Flyway"}),(0,i.jsx)(s.td,{children:"SQL / Java"}),(0,i.jsx)(s.td,{children:"Muy usada en entornos empresariales"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Liquibase"}),(0,i.jsx)(s.td,{children:"SQL / XML / YAML"}),(0,i.jsx)(s.td,{children:"Ideal para equipos grandes"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Knex Migrations"}),(0,i.jsx)(s.td,{children:"JS"}),(0,i.jsx)(s.td,{children:"Muy usada en Node.js"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Prisma Migrate"}),(0,i.jsx)(s.td,{children:"JS/TS"}),(0,i.jsx)(s.td,{children:"ORM + migraciones"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Alembic"}),(0,i.jsx)(s.td,{children:"Python"}),(0,i.jsx)(s.td,{children:"Standard en ecosistemas Flask/FastAPI"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Django Migrations"}),(0,i.jsx)(s.td,{children:"Python"}),(0,i.jsx)(s.td,{children:"Integrado al framework"})]})]})]}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udc49 Todas siguen el mismo patr\xf3n: scripts versionados, ordenados y reversibles."}),"\n",(0,i.jsx)(s.p,{children:"Ejemplo Knex:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-bash",children:"npx knex migrate:make add_stock_column\nnpx knex migrate:latest\nnpx knex migrate:rollback\n\n"})}),"\n",(0,i.jsx)(s.h2,{id:"-266-migraciones-autom\xe1ticas-vs-manuales",children:"\ud83e\udde0 26.6. Migraciones autom\xe1ticas vs manuales"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Manuales"})," \u2192 t\xfa escribes las instrucciones SQL a mano (m\xe1ximo control)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Autom\xe1ticas"})," \u2192 la herramienta las genera a partir de cambios en modelos (r\xe1pido, pero puede ser menos preciso)."]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udccc Recomendaci\xf3n pr\xe1ctica:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Usa autom\xe1ticas para cambios sencillos (agregar columnas, \xedndices)."}),"\n",(0,i.jsx)(s.li,{children:"Usa manuales para operaciones delicadas (mover datos, refactorizar claves, etc.)."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"-267-semillas-seeders--poblar-datos-iniciales",children:"\ud83e\udded 26.7. Semillas (seeders) \u2014 poblar datos iniciales"}),"\n",(0,i.jsx)(s.p,{children:"Adem\xe1s de migrar estructura, muchas apps necesitan:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Usuarios iniciales,"}),"\n",(0,i.jsx)(s.li,{children:"Configuraciones por defecto,"}),"\n",(0,i.jsx)(s.li,{children:"Cat\xe1logos b\xe1sicos (pa\xedses, roles, categor\xedas\u2026)."}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["\ud83d\udc49 Para eso usamos ",(0,i.jsx)(s.strong,{children:"semillas"})," (seed data)."]}),"\n",(0,i.jsx)(s.p,{children:"Ejemplo en SQL:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"INSERT INTO roles (nombre) VALUES ('admin'), ('editor'), ('lector');\nINSERT INTO categorias (nombre) VALUES ('Electr\xf3nica'), ('Ropa'), ('Libros');\n\n"})}),"\n",(0,i.jsx)(s.p,{children:"Ejemplo con Knex:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-jsx",children:"exports.seed = async function (knex) {\n  await knex('roles').insert([\n    { nombre: 'admin' },\n    { nombre: 'editor' },\n    { nombre: 'lector' }\n  ]);\n};\n\n"})}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udccc Esto se ejecuta despu\xe9s de las migraciones iniciales, garantizando que la BD arranca con datos m\xednimos funcionales."}),"\n",(0,i.jsx)(s.h2,{id:"-268-data-migrations--cuando-cambia-la-forma-de-los-datos",children:"\ud83e\uddf1 26.8. Data-migrations \u2014 cuando cambia la forma de los datos"}),"\n",(0,i.jsx)(s.p,{children:"No todos los cambios son estructurales."}),"\n",(0,i.jsxs)(s.p,{children:["A veces debes ",(0,i.jsx)(s.strong,{children:"modificar el contenido existente"})," porque cambi\xf3 el modelo l\xf3gico."]}),"\n",(0,i.jsx)(s.p,{children:"Ejemplo:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Antes: ",(0,i.jsx)(s.code,{children:"nombre_completo"})," en un solo campo."]}),"\n",(0,i.jsxs)(s.li,{children:["Ahora: ",(0,i.jsx)(s.code,{children:"nombre"})," y ",(0,i.jsx)(s.code,{children:"apellido"})," separados."]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"Up:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"ALTER TABLE usuarios ADD COLUMN nombre TEXT;\nALTER TABLE usuarios ADD COLUMN apellido TEXT;\n\nUPDATE usuarios\nSET nombre = split_part(nombre_completo, ' ', 1),\n    apellido = split_part(nombre_completo, ' ', 2);\n\nALTER TABLE usuarios DROP COLUMN nombre_completo;\n\n"})}),"\n",(0,i.jsx)(s.p,{children:"Down:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"ALTER TABLE usuarios ADD COLUMN nombre_completo TEXT;\nUPDATE usuarios\nSET nombre_completo = nombre || ' ' || apellido;\nALTER TABLE usuarios DROP COLUMN nombre;\nALTER TABLE usuarios DROP COLUMN apellido;\n\n"})}),"\n",(0,i.jsxs)(s.p,{children:["\ud83d\udc49 Esto es una ",(0,i.jsx)(s.strong,{children:"data-migration"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Cambia estructura + contenido."}),"\n",(0,i.jsx)(s.li,{children:"Debe ser tratada como una migraci\xf3n normal, versionada y reversible."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"-269-buenas-pr\xe1cticas-con-migraciones",children:"\ud83e\udded 26.9. Buenas pr\xe1cticas con migraciones"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Una migraci\xf3n debe ser ",(0,i.jsx)(s.strong,{children:"at\xf3mica"}),": hace un cambio l\xf3gico y nada m\xe1s."]}),"\n",(0,i.jsxs)(s.li,{children:["Usa nombres claros: ",(0,i.jsx)(s.code,{children:"001_add_stock_column.sql"}),", no ",(0,i.jsx)(s.code,{children:"mig1.sql"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Aseg\xfarate de que ",(0,i.jsx)(s.strong,{children:"todas las migraciones funcionan en orden limpio"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Mant\xe9n up y down sincronizados."}),"\n",(0,i.jsx)(s.li,{children:"Documenta por qu\xe9 se hizo cada cambio."}),"\n",(0,i.jsx)(s.li,{children:"Usa control de versiones (Git) para todo el historial."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"-2610-despliegues-seguros-con-migraciones",children:"\ud83e\udde0 26.10. Despliegues seguros con migraciones"}),"\n",(0,i.jsx)(s.p,{children:"En entornos reales:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Se ejecutan migraciones en staging antes que en producci\xf3n."}),"\n",(0,i.jsx)(s.li,{children:"Se automatizan con CI/CD."}),"\n",(0,i.jsx)(s.li,{children:"Se hacen backups previos si son cambios cr\xedticos."}),"\n",(0,i.jsx)(s.li,{children:"Se monitorean tiempos de ejecuci\xf3n para no bloquear la base."}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"\ud83d\udccc Ejemplo de pipeline t\xedpico:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"git push main\n\u2192 CI corre tests\n\u2192 CI aplica migraciones\n\u2192 Despliegue en staging\n\u2192 QA\n\u2192 Despliegue en producci\xf3n\n\n"})}),"\n",(0,i.jsx)(s.h2,{id:"-2611-errores-comunes",children:"\ud83d\udea8 26.11. Errores comunes"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Editar directamente la base de datos \u201ca mano\u201d en producci\xf3n \ud83d\ude2c"}),"\n",(0,i.jsx)(s.li,{children:"No escribir migraciones de reversi\xf3n (down)."}),"\n",(0,i.jsx)(s.li,{children:"Hacer migraciones gigantes que mezclan 10 cambios distintos."}),"\n",(0,i.jsx)(s.li,{children:"No poblar datos iniciales con seeders \u2192 sistemas vac\xedos que fallan."}),"\n",(0,i.jsx)(s.li,{children:"No versionar migraciones \u2192 caos entre entornos."}),"\n",(0,i.jsx)(s.li,{children:"Confiar en migraciones autom\xe1ticas sin revisarlas."}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(t,{...e})}):t(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>c});var a=n(6540);const i={},r=a.createContext(i);function o(e){const s=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(r.Provider,{value:s},e.children)}}}]);