"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[6500],{5348:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>t,contentTitle:()=>d,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"backend/JSON/exportarImportar","title":"Exportar e importar JSON","description":"Objetivo","source":"@site/docs/backend/JSON/exportarImportar.md","sourceDirName":"backend/JSON","slug":"/backend/JSON/exportarImportar","permalink":"/docuQuest/docs/backend/JSON/exportarImportar","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/JSON/exportarImportar.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Seguridad b\xe1sica y buenas pr\xe1cticas","permalink":"/docuQuest/docs/backend/JSON/seguridad"},"next":{"title":"Qu\xe9 es SQLite y c\xf3mo usarlo","permalink":"/docuQuest/docs/backend/sqlite/introduction"}}');var o=n(4848),s=n(8453);const i={},d="Exportar e importar JSON",t={},l=[{value:"Objetivo",id:"objetivo",level:2},{value:"Dise\xf1o",id:"dise\xf1o",level:2},{value:"Cambios en la API (server.js)",id:"cambios-en-la-api-serverjs",level:2},{value:"1) Helper de reutilizaci\xf3n de filtros/paginaci\xf3n (si tienes M\xf3dulo 13)",id:"1-helper-de-reutilizaci\xf3n-de-filtrospaginaci\xf3n-si-tienes-m\xf3dulo-13",level:3},{value:"2) Exportaci\xf3n: <code>GET /api/usuarios/export</code>",id:"2-exportaci\xf3n-get-apiusuariosexport",level:3},{value:"3) Importaci\xf3n: <code>POST /api/usuarios/import?mode=append|replace</code>",id:"3-importaci\xf3n-post-apiusuariosimportmodeappendreplace",level:3},{value:"Cliente m\xednimo: a\xf1adir Export/Import al M\xf3dulo 12",id:"cliente-m\xednimo-a\xf1adir-exportimport-al-m\xf3dulo-12",level:2},{value:"1) HTML: nuevos bloques en <code>public/index.html</code>",id:"1-html-nuevos-bloques-en-publicindexhtml",level:3},{value:"2) JS: l\xf3gica en <code>public/app.js</code>",id:"2-js-l\xf3gica-en-publicappjs",level:3},{value:"Pruebas r\xe1pidas con curl",id:"pruebas-r\xe1pidas-con-curl",level:2},{value:"Consideraciones did\xe1cticas y de seguridad",id:"consideraciones-did\xe1cticas-y-de-seguridad",level:2}];function c(e){const r={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"exportar-e-importar-json",children:"Exportar e importar JSON"})}),"\n",(0,o.jsx)(r.h2,{id:"objetivo",children:"Objetivo"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"Permitir descargar un volcado JSON de usuarios."}),"\n",(0,o.jsx)(r.li,{children:"Permitir importar una lista de usuarios desde el cliente, de forma controlada."}),"\n",(0,o.jsx)(r.li,{children:"Respetar las validaciones, l\xedmites y seguridad del M\xf3dulo 14."}),"\n",(0,o.jsx)(r.li,{children:"Mantener compatibilidad con la API y el cliente actuales."}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"dise\xf1o",children:"Dise\xf1o"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Exportaci\xf3n:"})," ",(0,o.jsx)(r.code,{children:"GET /api/usuarios/export"})," devuelve un archivo ",(0,o.jsx)(r.code,{children:".json"})," con los usuarios. Opcionalmente admite los mismos par\xe1metros de b\xfasqueda/orden/paginaci\xf3n del M\xf3dulo 13 para exportar un subconjunto."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.strong,{children:"Importaci\xf3n:"})," ",(0,o.jsx)(r.code,{children:"POST /api/usuarios/import?mode=append|replace"})," recibe un ",(0,o.jsx)(r.strong,{children:"array JSON"})," de usuarios sin ",(0,o.jsx)(r.code,{children:"id"}),", los valida y:","\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"append"}),": asigna nuevos ",(0,o.jsx)(r.code,{children:"id"})," y a\xf1ade al final."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"replace"}),": reemplaza todo el dataset, reasignando ",(0,o.jsx)(r.code,{children:"id"})," desde 1."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"Para mantenerlo simple, no usamos multipart. El cliente lee el archivo local con FileReader y env\xeda el JSON como application/json."}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"cambios-en-la-api-serverjs",children:"Cambios en la API (server.js)"}),"\n",(0,o.jsx)(r.p,{children:"A continuaci\xf3n solo a\xf1adimos los nuevos handlers. El resto de m\xf3dulos no se toca."}),"\n",(0,o.jsx)(r.h3,{id:"1-helper-de-reutilizaci\xf3n-de-filtrospaginaci\xf3n-si-tienes-m\xf3dulo-13",children:"1) Helper de reutilizaci\xf3n de filtros/paginaci\xf3n (si tienes M\xf3dulo 13)"}),"\n",(0,o.jsxs)(r.p,{children:["Si ya tienes la l\xf3gica de b\xfasqueda/orden/paginaci\xf3n dentro del handler ",(0,o.jsx)(r.code,{children:"GET /api/usuarios"}),", extrae esa parte a una funci\xf3n para poder reutilizarla en la exportaci\xf3n:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-jsx",children:'function aplicarQuerySobreLista(list, url) {\r\n  const q = (url.searchParams.get("q") || "").toLowerCase().trim();\r\n  const minEdad = url.searchParams.get("minEdad");\r\n  const maxEdad = url.searchParams.get("maxEdad");\r\n  const sort = (url.searchParams.get("sort") || "").trim();\r\n  const order = (url.searchParams.get("order") || "asc").toLowerCase();\r\n  const page = Number(url.searchParams.get("page") || 0);\r\n  const limit = Number(url.searchParams.get("limit") || 0);\r\n\r\n  let res = list;\r\n\r\n  if (q) {\r\n    res = res.filter((u) => {\r\n      const n = String(u.nombre ?? "").toLowerCase();\r\n      const e = String(u.email ?? "").toLowerCase();\r\n      return n.includes(q) || e.includes(q);\r\n    });\r\n  }\r\n  if (minEdad !== null) {\r\n    const min = Number(minEdad);\r\n    if (!Number.isNaN(min)) res = res.filter((u) => Number(u.edad) >= min);\r\n  }\r\n  if (maxEdad !== null) {\r\n    const max = Number(maxEdad);\r\n    if (!Number.isNaN(max)) res = res.filter((u) => Number(u.edad) <= max);\r\n  }\r\n\r\n  const allowedSort = new Set(["nombre", "email", "edad", "fecha"]);\r\n  if (allowedSort.has(sort)) {\r\n    const dir = order === "desc" ? -1 : 1;\r\n    res = res.slice().sort((a, b) => {\r\n      const va = a[sort],\r\n        vb = b[sort];\r\n      if (va == null && vb == null) return 0;\r\n      if (va == null) return 1;\r\n      if (vb == null) return -1;\r\n      if (typeof va === "number" && typeof vb === "number")\r\n        return (va - vb) * dir;\r\n      return String(va).localeCompare(String(vb)) * dir;\r\n    });\r\n  }\r\n\r\n  // Si hay paginaci\xf3n, devolver el slice; si no, devolver la lista completa\r\n  if (page && limit) {\r\n    const start = (page - 1) * limit;\r\n    const end = start + limit;\r\n    return res.slice(start, end);\r\n  }\r\n  return res;\r\n}\n'})}),"\n",(0,o.jsxs)(r.h3,{id:"2-exportaci\xf3n-get-apiusuariosexport",children:["2) Exportaci\xf3n: ",(0,o.jsx)(r.code,{children:"GET /api/usuarios/export"})]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-jsx",children:'if (method === "GET" && url.pathname === "/api/usuarios/export") {\r\n  const usuarios = await readJsonArray();\r\n  const subset = aplicarQuerySobreLista(usuarios, url); // opcional\r\n\r\n  const body = JSON.stringify(subset, null, 2);\r\n\r\n  // Cabeceras de descarga\r\n  applySecurityHeaders(res);\r\n  allowCors(req, res);\r\n  res.writeHead(200, {\r\n    "Content-Type": "application/json; charset=utf-8",\r\n    "Content-Disposition": `attachment; filename="usuarios-export.json"`,\r\n    "Content-Length": Buffer.byteLength(body),\r\n  });\r\n  return res.end(body);\r\n}\n'})}),"\n",(0,o.jsxs)(r.h3,{id:"3-importaci\xf3n-post-apiusuariosimportmodeappendreplace",children:["3) Importaci\xf3n: ",(0,o.jsx)(r.code,{children:"POST /api/usuarios/import?mode=append|replace"})]}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["Espera ",(0,o.jsx)(r.code,{children:"Content-Type: application/json"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["El cuerpo debe ser un ",(0,o.jsx)(r.strong,{children:"array"})," de objetos con ",(0,o.jsx)(r.code,{children:"nombre"}),", ",(0,o.jsx)(r.code,{children:"email"}),", ",(0,o.jsx)(r.code,{children:"edad"})," (sin ",(0,o.jsx)(r.code,{children:"id"}),")."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"mode=append"})," a\xf1ade y reasigna ",(0,o.jsx)(r.code,{children:"id"})," nuevos."]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"mode=replace"})," borra todo y recrea la lista con ",(0,o.jsx)(r.code,{children:"id"})," consecutivos."]}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-jsx",children:'if (method === "POST" && url.pathname === "/api/usuarios/import") {\r\n  try {\r\n    const mode = (url.searchParams.get("mode") || "append").toLowerCase();\r\n    if (!["append", "replace"].includes(mode)) {\r\n      return sendJson(res, 400, {\r\n        error: "mode inv\xe1lido. Usa append o replace",\r\n      });\r\n    }\r\n\r\n    const raw = await parseJsonBody(req); // ya valida content-type y tama\xf1o\r\n    if (!Array.isArray(raw)) {\r\n      return sendJson(res, 400, { error: "El cuerpo debe ser un array JSON" });\r\n    }\r\n\r\n    // Validar y sanear cada elemento\r\n    const candidatos = [];\r\n    for (const item of raw) {\r\n      // pickAndSanitizePayload whitelistea y convierte tipos\r\n      const payload = pickAndSanitizePayload(item);\r\n      validarUsuarioNuevo(payload); // puede lanzar\r\n      candidatos.push(payload);\r\n    }\r\n\r\n    let usuarios = await readJsonArray();\r\n\r\n    if (mode === "replace") {\r\n      usuarios = [];\r\n    }\r\n\r\n    // Evitar emails duplicados contra el dataset actual y entre los candidatos\r\n    const emailsActuales = new Set(usuarios.map((u) => u.email));\r\n    const emailsNuevos = new Set();\r\n\r\n    for (const c of candidatos) {\r\n      const e = c.email;\r\n      if (emailsActuales.has(e) || emailsNuevos.has(e)) {\r\n        return sendJson(res, 400, { error: `Email duplicado en import: ${e}` });\r\n      }\r\n      emailsNuevos.add(e);\r\n    }\r\n\r\n    // Asignar IDs nuevos consecutivos\r\n    let nextId = usuarios.length\r\n      ? Math.max(...usuarios.map((u) => u.id || 0)) + 1\r\n      : 1;\r\n    if (mode === "replace") nextId = 1;\r\n\r\n    const importados = candidatos.map((c) => ({\r\n      id: nextId++,\r\n      nombre: c.nombre,\r\n      email: c.email,\r\n      edad: c.edad,\r\n      fecha: new Date().toISOString().replace("T", " ").slice(0, 16),\r\n    }));\r\n\r\n    if (mode === "append") {\r\n      usuarios.push(...importados);\r\n    } else {\r\n      usuarios = importados;\r\n    }\r\n\r\n    await writeJsonArray(usuarios);\r\n    return sendJson(res, 201, {\r\n      ok: true,\r\n      importados: importados.length,\r\n      mode,\r\n    });\r\n  } catch (e) {\r\n    return sendJson(res, 400, { error: e.message });\r\n  }\r\n}\n'})}),"\n",(0,o.jsx)(r.h2,{id:"cliente-m\xednimo-a\xf1adir-exportimport-al-m\xf3dulo-12",children:"Cliente m\xednimo: a\xf1adir Export/Import al M\xf3dulo 12"}),"\n",(0,o.jsxs)(r.h3,{id:"1-html-nuevos-bloques-en-publicindexhtml",children:["1) HTML: nuevos bloques en ",(0,o.jsx)(r.code,{children:"public/index.html"})]}),"\n",(0,o.jsx)(r.p,{children:"A\xf1ade debajo del listado:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-html",children:'<hr class="my-4" />\r\n\r\n<section class="mb-4">\r\n  <h2 class="h5">Exportar</h2>\r\n  <div class="d-flex gap-2 flex-wrap">\r\n    <a id="btn-export" class="btn btn-outline-secondary" href="#" download\r\n      >Descargar JSON</a\r\n    >\r\n    <small class="text-muted"\r\n      >Exporta todos los usuarios o filtra con los mismos par\xe1metros de listado\r\n      si adaptas el cliente.</small\r\n    >\r\n  </div>\r\n</section>\r\n\r\n<section class="mb-4">\r\n  <h2 class="h5">Importar</h2>\r\n  <form id="form-import" class="row g-2">\r\n    <div class="col-md-4">\r\n      <input\r\n        type="file"\r\n        class="form-control"\r\n        id="file-json"\r\n        accept="application/json,.json"\r\n        required\r\n      />\r\n    </div>\r\n    <div class="col-md-4">\r\n      <select class="form-select" id="import-mode">\r\n        <option value="append">A\xf1adir (append)</option>\r\n        <option value="replace">Reemplazar (replace)</option>\r\n      </select>\r\n    </div>\r\n    <div class="col-md-2">\r\n      <button class="btn btn-warning w-100">Importar</button>\r\n    </div>\r\n  </form>\r\n  <p class="small-muted mt-2">\r\n    El archivo debe contener un array de objetos sin campo <code>id</code>, con\r\n    las propiedades <code>nombre</code>, <code>email</code>, <code>edad</code>.\r\n    Se aplican validaciones y limpieza.\r\n  </p>\r\n</section>\n'})}),"\n",(0,o.jsxs)(r.h3,{id:"2-js-l\xf3gica-en-publicappjs",children:["2) JS: l\xf3gica en ",(0,o.jsx)(r.code,{children:"public/app.js"})]}),"\n",(0,o.jsx)(r.p,{children:"A\xf1ade al final del archivo:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-jsx",children:'const $export = document.getElementById("btn-export");\r\nconst $importForm = document.getElementById("form-import");\r\nconst $file = document.getElementById("file-json");\r\nconst $mode = document.getElementById("import-mode");\r\n\r\n// Exportaci\xf3n simple (descarga directa)\r\nfunction buildExportUrl() {\r\n  // Sencillo: exporta todo. Si quieres, aqu\xed podr\xedas leer inputs de b\xfasqueda\r\n  // y componer query params id\xe9nticos al listado (q, sort, page, limit, etc.)\r\n  return `${API_BASE}/export`;\r\n}\r\n\r\nfunction refreshExportHref() {\r\n  $export.href = buildExportUrl();\r\n}\r\nrefreshExportHref();\r\n\r\n// Importaci\xf3n controlada\r\n$importForm.addEventListener("submit", async (e) => {\r\n  e.preventDefault();\r\n  const file = $file.files[0];\r\n  if (!file) {\r\n    showMsg("Selecciona un archivo JSON", "warning");\r\n    return;\r\n  }\r\n  const mode = $mode.value;\r\n\r\n  try {\r\n    setBusy(true);\r\n    const text = await file.text();\r\n    let data;\r\n    try {\r\n      data = JSON.parse(text);\r\n    } catch {\r\n      showMsg("El archivo no es JSON v\xe1lido", "danger");\r\n      return;\r\n    }\r\n    if (!Array.isArray(data)) {\r\n      showMsg("El JSON debe ser un array", "danger");\r\n      return;\r\n    }\r\n\r\n    const res = await fetch(\r\n      `${API_BASE}/import?mode=${encodeURIComponent(mode)}`,\r\n      {\r\n        method: "POST",\r\n        headers: { "Content-Type": "application/json" },\r\n        body: JSON.stringify(data),\r\n      }\r\n    );\r\n\r\n    const out = await res.json().catch(() => ({}));\r\n    if (!res.ok) {\r\n      throw new Error(out.error || "Error al importar");\r\n    }\r\n\r\n    showMsg(`Importaci\xf3n correcta: ${out.importados} registros (${out.mode})`);\r\n    $importForm.reset();\r\n    await loadUsers();\r\n  } catch (err) {\r\n    showMsg(err.message || "Error al importar", "danger");\r\n  } finally {\r\n    setBusy(false);\r\n  }\r\n});\n'})}),"\n",(0,o.jsx)(r.h2,{id:"pruebas-r\xe1pidas-con-curl",children:"Pruebas r\xe1pidas con curl"}),"\n",(0,o.jsx)(r.p,{children:"Exportar todo:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:'curl -OJ "http://localhost:3000/api/usuarios/export"\r\n\n'})}),"\n",(0,o.jsxs)(r.p,{children:["(El ",(0,o.jsx)(r.code,{children:"-OJ"})," intenta guardar con el nombre del servidor.)"]}),"\n",(0,o.jsx)(r.p,{children:"Exportar filtrando y ordenando (si aplicaste M\xf3dulo 13):"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:'curl -OJ "http://localhost:3000/api/usuarios/export?q=a&sort=edad&order=desc"\r\n\n'})}),"\n",(0,o.jsx)(r.p,{children:"Importar a\xf1adiendo:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:'curl -X POST "http://localhost:3000/api/usuarios/import?mode=append" \\\r\n  -H "Content-Type: application/json" \\\r\n  -d \'[{"nombre":"Toad","email":"toad@mail.com","edad":20},{"nombre":"Daisy","email":"daisy@mail.com","edad":27}]\'\r\n\n'})}),"\n",(0,o.jsx)(r.p,{children:"Importar reemplazando:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:'curl -X POST "http://localhost:3000/api/usuarios/import?mode=replace" \\\r\n  -H "Content-Type: application/json" \\\r\n  -d \'[{"nombre":"Nuevo1","email":"n1@mail.com","edad":30},{"nombre":"Nuevo2","email":"n2@mail.com","edad":31}]\'\r\n\n'})}),"\n",(0,o.jsx)(r.h2,{id:"consideraciones-did\xe1cticas-y-de-seguridad",children:"Consideraciones did\xe1cticas y de seguridad"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["La importaci\xf3n aplica la misma whitelist y validaciones del M\xf3dulo 14:","\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["Solo acepta ",(0,o.jsx)(r.code,{children:"nombre"}),", ",(0,o.jsx)(r.code,{children:"email"}),", ",(0,o.jsx)(r.code,{children:"edad"}),"."]}),"\n",(0,o.jsx)(r.li,{children:"Sanea strings, comprueba formato de email y rangos de edad."}),"\n",(0,o.jsx)(r.li,{children:"Controla duplicados por email contra los ya existentes y entre los importados."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["El archivo importado no debe traer ",(0,o.jsx)(r.code,{children:"id"}),". La API los asigna para evitar colisiones."]}),"\n",(0,o.jsxs)(r.li,{children:["La exportaci\xf3n usa ",(0,o.jsx)(r.code,{children:"Content-Disposition"})," para forzar descarga."]}),"\n",(0,o.jsx)(r.li,{children:"Si se usa paginaci\xf3n en exportaci\xf3n, el archivo contendr\xe1 solo el slice pedido. Por defecto, exporta todo."}),"\n"]})]})}function p(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>d});var a=n(6540);const o={},s=a.createContext(o);function i(e){const r=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),a.createElement(s.Provider,{value:r},e.children)}}}]);