"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[1450],{6434:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"backend/databases/Mantenimiento_de_indices_y_crecimiento","title":"Mantenimiento de \xedndices y crecimiento","description":"31.1. Por qu\xe9 mantener los \xedndices","source":"@site/docs/backend/databases/Mantenimiento_de_indices_y_crecimiento.md","sourceDirName":"backend/databases","slug":"/backend/databases/Mantenimiento_de_indices_y_crecimiento","permalink":"/docuQuest/docs/backend/databases/Mantenimiento_de_indices_y_crecimiento","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/databases/Mantenimiento_de_indices_y_crecimiento.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Copias de seguridad y recuperaci\xf3n","permalink":"/docuQuest/docs/backend/databases/Copias_de_seguridad_y_recuperacion"},"next":{"title":"Cambios en caliente","permalink":"/docuQuest/docs/backend/databases/Cambios_en_caliente"}}');var a=s(4848),r=s(8453);const d={},c="Mantenimiento de \xedndices y crecimiento",l={},o=[{value:"31.1. Por qu\xe9 mantener los \xedndices",id:"311-por-qu\xe9-mantener-los-\xedndices",level:2},{value:"31.2. Fragmentaci\xf3n de \xedndices \u2014 concepto b\xe1sico",id:"312-fragmentaci\xf3n-de-\xedndices--concepto-b\xe1sico",level:2},{value:"31.3. C\xf3mo detectar fragmentaci\xf3n",id:"313-c\xf3mo-detectar-fragmentaci\xf3n",level:2},{value:"31.4. Reindexaci\xf3n",id:"314-reindexaci\xf3n",level:2},{value:"31.5. VACUUM y limpieza peri\xf3dica",id:"315-vacuum-y-limpieza-peri\xf3dica",level:2},{value:"31.6. Estad\xedsticas actualizadas = buenos planes de consulta",id:"316-estad\xedsticas-actualizadas--buenos-planes-de-consulta",level:2},{value:"31.7. El housekeeping peri\xf3dico",id:"317-el-housekeeping-peri\xf3dico",level:2},{value:"31.8. Supervisar crecimiento",id:"318-supervisar-crecimiento",level:2},{value:"31.9. Archivar datos antiguos en lugar de borrarlos \u201ca saco\u201d",id:"319-archivar-datos-antiguos-en-lugar-de-borrarlos-a-saco",level:2},{value:"31.10. Buenas pr\xe1cticas de mantenimiento de \xedndices",id:"3110-buenas-pr\xe1cticas-de-mantenimiento-de-\xedndices",level:2},{value:"31.11. Errores comunes",id:"3111-errores-comunes",level:2}];function t(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"mantenimiento-de-\xedndices-y-crecimiento",children:"Mantenimiento de \xedndices y crecimiento"})}),"\n",(0,a.jsx)(n.h2,{id:"311-por-qu\xe9-mantener-los-\xedndices",children:"31.1. Por qu\xe9 mantener los \xedndices"}),"\n",(0,a.jsx)(n.p,{children:"Cuando insertas, actualizas y borras registros de una tabla a lo largo de meses o a\xf1os:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Las p\xe1ginas de \xedndices se llenan de huecos,"}),"\n",(0,a.jsx)(n.li,{children:"Las rutas de acceso se vuelven menos eficientes,"}),"\n",(0,a.jsxs)(n.li,{children:["Y el optimizador de consultas ",(0,a.jsx)(n.strong,{children:"deja de elegir los mejores planes"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"El rendimiento no se degrada de golpe: baja lentamente hasta que un d\xeda las consultas que antes tardaban 50 ms\u2026 tardan 5 segundos \ud83d\ude2c."}),"\n",(0,a.jsxs)(n.p,{children:["Por eso es importante tener ",(0,a.jsx)(n.strong,{children:"mantenimiento planificado"}),", no reactivo."]}),"\n",(0,a.jsx)(n.h2,{id:"312-fragmentaci\xf3n-de-\xedndices--concepto-b\xe1sico",children:"31.2. Fragmentaci\xf3n de \xedndices \u2014 concepto b\xe1sico"}),"\n",(0,a.jsxs)(n.p,{children:["Los \xedndices (por ejemplo, B-Tree en la mayor\xeda de motores) est\xe1n organizados en ",(0,a.jsx)(n.strong,{children:"p\xe1ginas"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Con el tiempo:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Borrados \u2192 dejan huecos,"}),"\n",(0,a.jsx)(n.li,{children:"Actualizaciones \u2192 reordenan nodos,"}),"\n",(0,a.jsx)(n.li,{children:"Inserts desordenados \u2192 aumentan profundidad."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"D\xeda 1: \xedndice limpio \u2192 consultas r\xe1pidas."}),"\n",(0,a.jsx)(n.li,{children:"D\xeda 200: muchos deletes/inserts \u2192 \xe1rbol con huecos \u2192 m\xe1s saltos \u2192 consultas lentas."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Un \xedndice fragmentado ",(0,a.jsx)(n.strong,{children:"no se ve a simple vista"}),", pero afecta directamente al rendimiento."]}),"\n",(0,a.jsx)(n.h2,{id:"313-c\xf3mo-detectar-fragmentaci\xf3n",children:"31.3. C\xf3mo detectar fragmentaci\xf3n"}),"\n",(0,a.jsx)(n.p,{children:"La mayor\xeda de motores tienen vistas internas o herramientas de diagn\xf3stico."}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo (PostgreSQL):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT\n  relname AS tabla,\n  indexrelname AS indice,\n  idx_scan,\n  idx_tup_read,\n  idx_tup_fetch,\n  pg_size_pretty(pg_relation_size(indexrelid)) AS tamano\nFROM pg_stat_user_indexes\nORDER BY idx_scan DESC;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Esto permite ver:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Cu\xe1ntas veces se usa cada \xedndice,"}),"\n",(0,a.jsx)(n.li,{children:"Su tama\xf1o real en disco,"}),"\n",(0,a.jsx)(n.li,{children:"Cu\xe1les podr\xedan necesitar mantenimiento."}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Tambi\xe9n puedes consultar la ",(0,a.jsx)(n.strong,{children:"tasa de bloat (fragmentaci\xf3n)"})," con extensiones como ",(0,a.jsx)(n.code,{children:"pgstattuple"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM pgstattuple('mi_indice');\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"\xcdndices grandes + poco uso \u2192 candidatos a limpiar o eliminar."}),"\n",(0,a.jsx)(n.p,{children:"\xcdndices muy usados + mucho bloat \u2192 candidatos a reindexar."}),"\n",(0,a.jsx)(n.h2,{id:"314-reindexaci\xf3n",children:"31.4. Reindexaci\xf3n"}),"\n",(0,a.jsxs)(n.p,{children:["Cuando un \xedndice est\xe1 fragmentado, la soluci\xf3n m\xe1s directa es ",(0,a.jsx)(n.strong,{children:"reconstruirlo"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"REINDEX INDEX mi_indice;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"o para toda la tabla:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"REINDEX TABLE productos;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Esto:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Reorganiza internamente el \xedndice,"}),"\n",(0,a.jsx)(n.li,{children:"Libera espacio,"}),"\n",(0,a.jsx)(n.li,{children:"Mejora tiempos de b\xfasqueda."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Lo ideal es hacerlo en horarios de baja carga."}),"\n",(0,a.jsx)(n.p,{children:"Algunos motores permiten reindexar concurrentemente para no bloquear."}),"\n",(0,a.jsx)(n.h2,{id:"315-vacuum-y-limpieza-peri\xf3dica",children:"31.5. VACUUM y limpieza peri\xf3dica"}),"\n",(0,a.jsxs)(n.p,{children:["En motores como PostgreSQL, adem\xe1s de reindexar, hay que ",(0,a.jsx)(n.strong,{children:"limpiar espacio muerto"})," con ",(0,a.jsx)(n.code,{children:"VACUUM"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"VACUUM ANALYZE productos;\n\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"VACUUM"})," \u2192 limpia tuplas borradas y libera espacio interno."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"ANALYZE"})," \u2192 actualiza estad\xedsticas del planificador de consultas."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Esto no borra datos reales ni afecta a usuarios."}),"\n",(0,a.jsxs)(n.p,{children:["Pero ",(0,a.jsx)(n.strong,{children:"mejora el rendimiento silenciosamente"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Tambi\xe9n existe ",(0,a.jsx)(n.code,{children:"AUTOVACUUM"}),", que se ejecuta autom\xe1ticamente,"]}),"\n",(0,a.jsx)(n.p,{children:"pero en sistemas grandes conviene reforzarlo con tareas programadas controladas."}),"\n",(0,a.jsx)(n.h2,{id:"316-estad\xedsticas-actualizadas--buenos-planes-de-consulta",children:"31.6. Estad\xedsticas actualizadas = buenos planes de consulta"}),"\n",(0,a.jsxs)(n.p,{children:["Los optimizadores de bases relacionales ",(0,a.jsx)(n.strong,{children:"deciden c\xf3mo ejecutar consultas"})," en base a:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"N\xfamero estimado de filas,"}),"\n",(0,a.jsx)(n.li,{children:"Distribuci\xf3n de valores,"}),"\n",(0,a.jsx)(n.li,{children:"Cardinalidad de columnas."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Si las estad\xedsticas est\xe1n desactualizadas:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["El motor ",(0,a.jsx)(n.strong,{children:"elige malos \xedndices"}),","]}),"\n",(0,a.jsx)(n.li,{children:"Hace joins ineficientes,"}),"\n",(0,a.jsx)(n.li,{children:"Ejecuta planes m\xe1s lentos."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"ANALYZE productos;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Esto fuerza la actualizaci\xf3n de estad\xedsticas de esa tabla."}),"\n",(0,a.jsxs)(n.p,{children:["Muchas veces, un simple ",(0,a.jsx)(n.code,{children:"ANALYZE"})," puede mejorar tiempos de consulta sin tocar nada m\xe1s."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Buenas estad\xedsticas = menos sorpresas en producci\xf3n."})}),"\n",(0,a.jsx)(n.h2,{id:"317-el-housekeeping-peri\xf3dico",children:"31.7. El housekeeping peri\xf3dico"}),"\n",(0,a.jsxs)(n.p,{children:["\u201cHousekeeping\u201d = ",(0,a.jsx)(n.strong,{children:"mantenimiento programado recurrente"})," que mantiene la base sana sin intervenci\xf3n manual."]}),"\n",(0,a.jsx)(n.p,{children:"En la pr\xe1ctica se compone de:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Limpieza (VACUUM o equivalente)."}),"\n",(0,a.jsx)(n.li,{children:"Actualizaci\xf3n de estad\xedsticas (ANALYZE)."}),"\n",(0,a.jsx)(n.li,{children:"Reindexaci\xf3n selectiva."}),"\n",(0,a.jsx)(n.li,{children:"Rotaci\xf3n de logs y auditor\xedas."}),"\n",(0,a.jsx)(n.li,{children:"Limpieza de datos temporales."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo cron (PostgreSQL):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'0 3 * * * psql -d tienda -c "VACUUM ANALYZE;"\n0 4 * * 0 psql -d tienda -c "REINDEX DATABASE tienda;"\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Esto mantiene la base optimizada sin que los usuarios lo noten."}),"\n",(0,a.jsx)(n.h2,{id:"318-supervisar-crecimiento",children:"31.8. Supervisar crecimiento"}),"\n",(0,a.jsxs)(n.p,{children:["Adem\xe1s de limpiar, debes ",(0,a.jsx)(n.strong,{children:"vigilar el crecimiento"})," de tablas e \xedndices."]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo de consulta para tama\xf1os:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"SELECT\n  relname AS objeto,\n  pg_size_pretty(pg_total_relation_size(relid)) AS tamano_total,\n  pg_size_pretty(pg_relation_size(relid)) AS tamano_tabla,\n  pg_size_pretty(pg_total_relation_size(relid) - pg_relation_size(relid)) AS tamano_indices\nFROM pg_catalog.pg_statio_user_tables\nORDER BY pg_total_relation_size(relid) DESC;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Esto te permite identificar:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Tablas que crecen m\xe1s de lo previsto,"}),"\n",(0,a.jsx)(n.li,{children:"\xcdndices desproporcionados,"}),"\n",(0,a.jsx)(n.li,{children:"Necesidad de archivar datos antiguos."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Un crecimiento descontrolado puede saturar el disco incluso si las consultas est\xe1n bien optimizadas."}),"\n",(0,a.jsx)(n.h2,{id:"319-archivar-datos-antiguos-en-lugar-de-borrarlos-a-saco",children:"31.9. Archivar datos antiguos en lugar de borrarlos \u201ca saco\u201d"}),"\n",(0,a.jsxs)(n.p,{children:["Muchas empresas no necesitan ",(0,a.jsx)(n.strong,{children:"consultar datos viejos constantemente"}),", pero s\xed conservarlos."]}),"\n",(0,a.jsx)(n.p,{children:"Soluci\xf3n pr\xe1ctica:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Mover datos antiguos a tablas de archivo."}),"\n",(0,a.jsx)(n.li,{children:"Borrarlos de las tablas activas."}),"\n",(0,a.jsx)(n.li,{children:"Mantener \xedndices m\xe1s peque\xf1os y eficientes."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"INSERT INTO pedido_archivo SELECT * FROM pedido WHERE fecha < NOW() - INTERVAL '1 year';\nDELETE FROM pedido WHERE fecha < NOW() - INTERVAL '1 year';\nVACUUM ANALYZE pedido;\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"As\xed las tablas activas se mantienen ligeras y r\xe1pidas."}),"\n",(0,a.jsx)(n.h2,{id:"3110-buenas-pr\xe1cticas-de-mantenimiento-de-\xedndices",children:"31.10. Buenas pr\xe1cticas de mantenimiento de \xedndices"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"No reindexes todo a lo loco."})," Prioriza \xedndices grandes y usados."]}),"\n",(0,a.jsxs)(n.li,{children:["Programa mantenimiento en ",(0,a.jsx)(n.strong,{children:"ventanas de baja carga"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Usa ",(0,a.jsx)(n.code,{children:"AUTOVACUUM"})," pero complementa con limpiezas programadas."]}),"\n",(0,a.jsx)(n.li,{children:"Mant\xe9n estad\xedsticas frescas."}),"\n",(0,a.jsx)(n.li,{children:"Supervisa crecimiento de tablas e \xedndices."}),"\n",(0,a.jsx)(n.li,{children:"Considera archivar datos antiguos en lugar de borrarlos sin m\xe1s."}),"\n",(0,a.jsx)(n.li,{children:"Documenta qu\xe9 tareas de housekeeping se ejecutan y cu\xe1ndo."}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"3111-errores-comunes",children:"31.11. Errores comunes"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Olvidarse de los \xedndices despu\xe9s de crearlos."}),"\n",(0,a.jsx)(n.li,{children:"Depender exclusivamente de autovacuum sin supervisi\xf3n."}),"\n",(0,a.jsx)(n.li,{children:"No medir ni monitorear crecimiento \u2192 problemas tard\xedos."}),"\n",(0,a.jsx)(n.li,{children:"Reindexar indiscriminadamente sin priorizar."}),"\n",(0,a.jsx)(n.li,{children:"Dejar estad\xedsticas desactualizadas \u2192 planes de ejecuci\xf3n p\xe9simos."}),"\n",(0,a.jsx)(n.li,{children:"No archivar datos \u2192 tablas gigantes que ralentizan todo."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>c});var i=s(6540);const a={},r=i.createContext(a);function d(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:d(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);