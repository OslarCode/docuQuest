"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[8001],{3328:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"backend/databases/Pruebas_de_bases_de_datos","title":"Pruebas de bases de datos","description":"27.1. Por qu\xe9 probar la base de datos","source":"@site/docs/backend/databases/Pruebas_de_bases_de_datos.md","sourceDirName":"backend/databases","slug":"/backend/databases/Pruebas_de_bases_de_datos","permalink":"/docuQuest/docs/backend/databases/Pruebas_de_bases_de_datos","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/databases/Pruebas_de_bases_de_datos.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Control de cambios del esquema","permalink":"/docuQuest/docs/backend/databases/Control_de_cambios_del_esquema"},"next":{"title":"Importaci\xf3n y exportaci\xf3n fiable","permalink":"/docuQuest/docs/backend/databases/Importacion_y_exportacion_fiable"}}');var a=n(4848),i=n(8453);const l={},o="Pruebas de bases de datos",d={},c=[{value:"27.1. Por qu\xe9 probar la base de datos",id:"271-por-qu\xe9-probar-la-base-de-datos",level:2},{value:"27.2. Qu\xe9 se prueba exactamente en la base",id:"272-qu\xe9-se-prueba-exactamente-en-la-base",level:2},{value:"27.3. Fixtures \u2014 datos controlados para probar",id:"273-fixtures--datos-controlados-para-probar",level:2},{value:"27.4. Ejemplo pr\xe1ctico \u2014 verificaci\xf3n de integridad",id:"274-ejemplo-pr\xe1ctico--verificaci\xf3n-de-integridad",level:2},{value:"27.5. Verificaci\xf3n de consultas cr\xedticas",id:"275-verificaci\xf3n-de-consultas-cr\xedticas",level:2},{value:"27.6. Migraciones y tests autom\xe1ticos",id:"276-migraciones-y-tests-autom\xe1ticos",level:2},{value:"27.7. Testeo de triggers, restricciones y reglas de negocio",id:"277-testeo-de-triggers-restricciones-y-reglas-de-negocio",level:2},{value:"27.8. Revisi\xf3n de regresiones en CI",id:"278-revisi\xf3n-de-regresiones-en-ci",level:2},{value:"27.9. Buenas pr\xe1cticas para pruebas de base de datos",id:"279-buenas-pr\xe1cticas-para-pruebas-de-base-de-datos",level:2},{value:"27.10. Errores comunes",id:"2710-errores-comunes",level:2}];function t(e){const s={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.header,{children:(0,a.jsx)(s.h1,{id:"pruebas-de-bases-de-datos",children:"Pruebas de bases de datos"})}),"\n",(0,a.jsx)(s.h2,{id:"271-por-qu\xe9-probar-la-base-de-datos",children:"27.1. Por qu\xe9 probar la base de datos"}),"\n",(0,a.jsx)(s.p,{children:"Muchas apps fallan no por errores de c\xf3digo\u2026 sino por:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Cambios en el esquema no testeados."}),"\n",(0,a.jsx)(s.li,{children:"Datos inconsistentes tras migraciones."}),"\n",(0,a.jsx)(s.li,{children:"Consultas que devuelven resultados inesperados."}),"\n",(0,a.jsx)(s.li,{children:"Integridad referencial rota sin darse cuenta."}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Las pruebas de base de datos sirven para:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Detectar errores ",(0,a.jsx)(s.strong,{children:"antes"})," de llegar a producci\xf3n."]}),"\n",(0,a.jsx)(s.li,{children:"Asegurar que las migraciones no rompen integridad."}),"\n",(0,a.jsx)(s.li,{children:"Verificar que las consultas cr\xedticas siguen funcionando."}),"\n",(0,a.jsx)(s.li,{children:"Facilitar despliegues y rollback seguros."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"272-qu\xe9-se-prueba-exactamente-en-la-base",children:"27.2. Qu\xe9 se prueba exactamente en la base"}),"\n",(0,a.jsxs)(s.ol,{children:["\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Estructura"}),":","\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Existen las tablas esperadas."}),"\n",(0,a.jsx)(s.li,{children:"Las columnas tienen el tipo correcto."}),"\n",(0,a.jsx)(s.li,{children:"Las constraints est\xe1n activas."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Integridad"}),":","\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"FKs, restricciones UNIQUE, CHECK\u2026 se cumplen."}),"\n",(0,a.jsx)(s.li,{children:"No hay relaciones rotas."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Consultas cr\xedticas"}),":","\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Devuelven los resultados esperados para casos conocidos."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Reglas de negocio en BD"}),":","\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Triggers, vistas, funciones y restricciones hacen lo correcto."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Migraciones"}),":","\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Se aplican y revierten sin errores."}),"\n",(0,a.jsx)(s.li,{children:"No rompen datos existentes."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"273-fixtures--datos-controlados-para-probar",children:"27.3. Fixtures \u2014 datos controlados para probar"}),"\n",(0,a.jsxs)(s.p,{children:["Un ",(0,a.jsx)(s.strong,{children:"fixture"})," es un conjunto de datos ",(0,a.jsx)(s.strong,{children:"peque\xf1o, limpio y conocido"})," que sirve para:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Alimentar la BD en un estado reproducible,"}),"\n",(0,a.jsx)(s.li,{children:"Ejecutar pruebas consistentes,"}),"\n",(0,a.jsx)(s.li,{children:"Comparar resultados predecibles."}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo de fixture simple (SQL):"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"INSERT INTO clientes (id, nombre, correo)\nVALUES (1, 'Ana', 'ana@example.com'),\n       (2, 'Luis', 'luis@example.com');\n\nINSERT INTO pedidos (id, cliente_id, total)\nVALUES (101, 1, 50.00),\n       (102, 2, 75.00);\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Con estos datos conocidos, puedes probar:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Que las consultas JOIN devuelven lo correcto."}),"\n",(0,a.jsx)(s.li,{children:"Que no hay problemas de FK."}),"\n",(0,a.jsx)(s.li,{children:"Que triggers o reglas de negocio se comportan como se espera."}),"\n"]}),"\n",(0,a.jsxs)(s.p,{children:["Es recomendable ",(0,a.jsx)(s.strong,{children:"mantener fixtures bajo control de versiones"})," junto con el c\xf3digo."]}),"\n",(0,a.jsx)(s.h2,{id:"274-ejemplo-pr\xe1ctico--verificaci\xf3n-de-integridad",children:"27.4. Ejemplo pr\xe1ctico \u2014 verificaci\xf3n de integridad"}),"\n",(0,a.jsx)(s.p,{children:"Sup\xf3n estas tablas:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE TABLE cliente (\n  id INT PRIMARY KEY,\n  nombre TEXT\n);\n\nCREATE TABLE pedido (\n  id INT PRIMARY KEY,\n  cliente_id INT REFERENCES cliente(id)\n);\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Si insertas un pedido con un cliente inexistente:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"INSERT INTO pedido (id, cliente_id) VALUES (1, 999);\n\n"})}),"\n",(0,a.jsxs)(s.p,{children:["La prueba debe ",(0,a.jsx)(s.strong,{children:"fallar"})," porque viola la FK."]}),"\n",(0,a.jsx)(s.p,{children:"Una prueba automatizada en Node.js podr\xeda ser:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-jsx",children:'import { strict as assert } from "assert";\nimport db from "./db.js";\n\nawait db.query("BEGIN");\ntry {\n  await db.query(\n    "INSERT INTO pedido (id, cliente_id) VALUES ($1, $2)",\n    [1, 999]\n  );\n  assert.fail("La FK deber\xeda haber fallado");\n} catch (e) {\n  assert.ok(e.message.includes("violates foreign key constraint"));\n} finally {\n  await db.query("ROLLBACK");\n}\n'})}),"\n",(0,a.jsx)(s.p,{children:"No se da\xf1a la base real porque usamos una transacci\xf3n revertida."}),"\n",(0,a.jsx)(s.p,{children:"Si alguien rompe la FK en una migraci\xf3n futura, la CI lo detectar\xe1."}),"\n",(0,a.jsx)(s.h2,{id:"275-verificaci\xf3n-de-consultas-cr\xedticas",children:"27.5. Verificaci\xf3n de consultas cr\xedticas"}),"\n",(0,a.jsxs)(s.p,{children:["Si tienes consultas de negocio que ",(0,a.jsx)(s.strong,{children:"no deben romperse nunca"})," (por ejemplo, informes o dashboards), conviene probarlas directamente:"]}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"SELECT c.nombre, COUNT(p.id) AS pedidos\nFROM cliente c\nLEFT JOIN pedido p ON c.id = p.cliente_id\nGROUP BY c.id;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Test:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-jsx",children:"const result = await db.query(/* consulta */);\nassert.equal(result.rows[0].pedidos, 1);\nassert.equal(result.rows[1].pedidos, 1);\n"})}),"\n",(0,a.jsx)(s.p,{children:"Si alguien cambia columnas, nombres, JOINs o l\xf3gica \u2192 el test falla antes de desplegar."}),"\n",(0,a.jsx)(s.h2,{id:"276-migraciones-y-tests-autom\xe1ticos",children:"27.6. Migraciones y tests autom\xe1ticos"}),"\n",(0,a.jsx)(s.p,{children:"Una buena pr\xe1ctica es:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Ejecutar todas las ",(0,a.jsx)(s.strong,{children:"migraciones desde cero"})," en un entorno de test."]}),"\n",(0,a.jsx)(s.li,{children:"Aplicar los fixtures."}),"\n",(0,a.jsx)(s.li,{children:"Correr los tests de integridad y consultas."}),"\n",(0,a.jsx)(s.li,{children:"(Opcional) revertir migraciones y comprobar que tambi\xe9n funcionan al bajar."}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo de script de CI:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-bash",children:"npm run migrate:latest\nnpm run seed\nnpm test\nnpm run migrate:rollback --all\n\n"})}),"\n",(0,a.jsxs)(s.p,{children:["Esto asegura que las migraciones ",(0,a.jsx)(s.strong,{children:"son realmente reproducibles"})," y no dependen de un entorno \u201cm\xe1gico\u201d que ya estaba montado."]}),"\n",(0,a.jsx)(s.h2,{id:"277-testeo-de-triggers-restricciones-y-reglas-de-negocio",children:"27.7. Testeo de triggers, restricciones y reglas de negocio"}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Regla: \u201cNo se puede hacer un pedido con total negativo\u201d."}),"\n"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"ALTER TABLE pedido ADD CONSTRAINT total_no_negativo CHECK (total >= 0);\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Test:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-jsx",children:'await db.query("BEGIN");\ntry {\n  await db.query(\n    "INSERT INTO pedido (id, cliente_id, total) VALUES (103, 1, -50)"\n  );\n  assert.fail("Deber\xeda haber lanzado error por CHECK");\n} catch (e) {\n  assert.ok(e.message.includes("total_no_negativo"));\n} finally {\n  await db.query("ROLLBACK");\n}\n'})}),"\n",(0,a.jsxs)(s.p,{children:["Esto permite ",(0,a.jsx)(s.strong,{children:"verificar reglas internas de la base"})," sin necesidad de probarlas indirectamente desde el frontend o backend."]}),"\n",(0,a.jsx)(s.h2,{id:"278-revisi\xf3n-de-regresiones-en-ci",children:"27.8. Revisi\xf3n de regresiones en CI"}),"\n",(0,a.jsxs)(s.p,{children:["Cuando integras esto en ",(0,a.jsx)(s.strong,{children:"CI/CD"}),":"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Cada PR ejecuta migraciones desde cero."}),"\n",(0,a.jsx)(s.li,{children:"Carga los fixtures."}),"\n",(0,a.jsx)(s.li,{children:"Corre todos los tests SQL."}),"\n",(0,a.jsxs)(s.li,{children:["Si algo se rompe (FK, restricciones, consultas), CI falla y ",(0,a.jsx)(s.strong,{children:"el error no llega a producci\xf3n"}),"."]}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo (pipeline simple):"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{children:"- docker-compose up db\n- npm run migrate:latest\n- npm run seed\n- npm test\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Esto protege tu esquema igual que los tests unitarios protegen tu l\xf3gica de negocio."}),"\n",(0,a.jsx)(s.h2,{id:"279-buenas-pr\xe1cticas-para-pruebas-de-base-de-datos",children:"27.9. Buenas pr\xe1cticas para pruebas de base de datos"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Mant\xe9n fixtures peque\xf1os, claros y versionados."}),"\n",(0,a.jsx)(s.li,{children:"Usa transacciones para aislar tests y no ensuciar la base."}),"\n",(0,a.jsx)(s.li,{children:"Cubre constraints, triggers, FKs y consultas cr\xedticas."}),"\n",(0,a.jsx)(s.li,{children:"Integra las pruebas en la CI, no solo en local."}),"\n",(0,a.jsx)(s.li,{children:"Aseg\xfarate de que las migraciones se aplican y revierten limpias."}),"\n",(0,a.jsx)(s.li,{children:"No dependas de \u201cbaselines manuales\u201d o dumps sin versionar."}),"\n",(0,a.jsx)(s.li,{children:"Loguea fallos con contexto (tabla, migraci\xf3n, error exacto)."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"2710-errores-comunes",children:"27.10. Errores comunes"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"No probar la base porque \u201clos tests ya est\xe1n en backend\u201d."}),"\n",(0,a.jsx)(s.li,{children:"Asumir que si la migraci\xf3n funciona una vez, funcionar\xe1 siempre."}),"\n",(0,a.jsx)(s.li,{children:"No validar reglas de integridad en CI."}),"\n",(0,a.jsx)(s.li,{children:"Fixtures enormes y desorganizados."}),"\n",(0,a.jsx)(s.li,{children:"Dejar de actualizar tests cuando cambia el esquema."}),"\n",(0,a.jsx)(s.li,{children:"No limpiar datos entre tests (contaminaci\xf3n cruzada)."}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>o});var r=n(6540);const a={},i=r.createContext(a);function l(e){const s=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),r.createElement(i.Provider,{value:s},e.children)}}}]);