"use strict";(globalThis.webpackChunkDocuQuest_oslar_code=globalThis.webpackChunkDocuQuest_oslar_code||[]).push([[965],{5440:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>r});const i=JSON.parse('{"id":"backend/databases/Vistas_logicas_y_composicion_de_consulta","title":"Vistas l\xf3gicas y composici\xf3n de consultas complejas","description":"11.1. El problema de las consultas \u201cmonstruo\u201d","source":"@site/docs/backend/databases/Vistas_logicas_y_composicion_de_consulta.md","sourceDirName":"backend/databases","slug":"/backend/databases/Vistas_logicas_y_composicion_de_consulta","permalink":"/docuQuest/docs/backend/databases/Vistas_logicas_y_composicion_de_consulta","draft":false,"unlisted":false,"editUrl":"https://github.com/OslarCode/OslarCode/docs/backend/databases/Vistas_logicas_y_composicion_de_consulta.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Joins, agrupaciones y filtros avanzados","permalink":"/docuQuest/docs/backend/databases/Joins_agrupaciones_y_filtros_avanzados"},"next":{"title":"Claves e integridad referencial avanzada","permalink":"/docuQuest/docs/backend/databases/Claves_e_integridad_referencial_avanzada"}}');var a=n(4848),d=n(8453);const o={},l="Vistas l\xf3gicas y composici\xf3n de consultas complejas",c={},r=[{value:"11.1. El problema de las consultas \u201cmonstruo\u201d",id:"111-el-problema-de-las-consultas-monstruo",level:2},{value:"11.2. Composici\xf3n de consultas \u2014 la idea base",id:"112-composici\xf3n-de-consultas--la-idea-base",level:2},{value:"11.3. Subconsultas \u2014 anidar resultados intermedios",id:"113-subconsultas--anidar-resultados-intermedios",level:2},{value:"11.4. CTE \u2014 Common Table Expressions (WITH)",id:"114-cte--common-table-expressions-with",level:2},{value:"11.5. Vistas \u2014 encapsulaci\xf3n persistente",id:"115-vistas--encapsulaci\xf3n-persistente",level:2},{value:"11.6. Vistas vs CTE \u2014 cu\xe1ndo usar cada una",id:"116-vistas-vs-cte--cu\xe1ndo-usar-cada-una",level:2},{value:"11.7. Vistas encadenadas \u2014 composici\xf3n jer\xe1rquica",id:"117-vistas-encadenadas--composici\xf3n-jer\xe1rquica",level:2},{value:"11.8. Ejemplo pr\xe1ctico \u2014 Sistema de biblioteca",id:"118-ejemplo-pr\xe1ctico--sistema-de-biblioteca",level:2},{value:"11.9. Buenas pr\xe1cticas con vistas y CTE",id:"119-buenas-pr\xe1cticas-con-vistas-y-cte",level:2},{value:"Errores comunes",id:"errores-comunes",level:2}];function t(e){const s={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.header,{children:(0,a.jsx)(s.h1,{id:"vistas-l\xf3gicas-y-composici\xf3n-de-consultas-complejas",children:"Vistas l\xf3gicas y composici\xf3n de consultas complejas"})}),"\n",(0,a.jsx)(s.h2,{id:"111-el-problema-de-las-consultas-monstruo",children:"11.1. El problema de las consultas \u201cmonstruo\u201d"}),"\n",(0,a.jsx)(s.p,{children:"En sistemas reales, no es raro ver consultas as\xed \ud83d\udc47"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"SELECT c.nombre AS cliente,\n       SUM(pp.cantidad * p.precio) AS total_gastado,\n       COUNT(DISTINCT pp.id_pedido) AS total_pedidos,\n       MIN(pp.fecha) AS primer_pedido,\n       MAX(pp.fecha) AS ultimo_pedido\nFROM cliente c\nJOIN pedido pp ON c.id_cliente = pp.id_cliente\nJOIN pedido_producto pdp ON pp.id_pedido = pdp.id_pedido\nJOIN producto p ON pdp.id_producto = p.id_producto\nWHERE c.activo = TRUE\n  AND pp.fecha BETWEEN '2025-01-01' AND '2025-12-31'\nGROUP BY c.nombre\nHAVING SUM(pp.total) > 1000\nORDER BY total_gastado DESC;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Es funcional, s\xed."}),"\n",(0,a.jsx)(s.p,{children:"Pero:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Es dif\xedcil de leer,"}),"\n",(0,a.jsx)(s.li,{children:"Complicada de mantener,"}),"\n",(0,a.jsx)(s.li,{children:"Y si la quieres reutilizar con ligeras variaciones\u2026 se vuelve un infierno."}),"\n"]}),"\n",(0,a.jsxs)(s.p,{children:["La soluci\xf3n: ",(0,a.jsx)(s.strong,{children:"composici\xf3n de consultas"}),"."]}),"\n",(0,a.jsx)(s.h2,{id:"112-composici\xf3n-de-consultas--la-idea-base",children:"11.2. Composici\xf3n de consultas \u2014 la idea base"}),"\n",(0,a.jsx)(s.p,{children:"La idea es simple pero poderosa:"}),"\n",(0,a.jsxs)(s.blockquote,{children:["\n",(0,a.jsx)(s.p,{children:"\u201cDivide una consulta compleja en bloques l\xf3gicos reutilizables.\u201d"}),"\n"]}),"\n",(0,a.jsxs)(s.p,{children:["Y puedes hacerlo de ",(0,a.jsx)(s.strong,{children:"dos maneras principales"}),":"]}),"\n",(0,a.jsxs)(s.ol,{children:["\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Subconsultas / Common Table Expressions (CTE)"})," \u2014 composici\xf3n temporal dentro de la misma query."]}),"\n",(0,a.jsxs)(s.li,{children:[(0,a.jsx)(s.strong,{children:"Vistas (VIEW)"})," \u2014 composici\xf3n persistente, reutilizable en varias consultas."]}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"113-subconsultas--anidar-resultados-intermedios",children:"11.3. Subconsultas \u2014 anidar resultados intermedios"}),"\n",(0,a.jsx)(s.p,{children:"Caso: queremos saber cu\xe1nto gast\xf3 cada cliente, pero la parte de calcular el total de cada pedido es repetitiva."}),"\n",(0,a.jsx)(s.p,{children:"En lugar de:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"SELECT c.nombre, SUM(pdp.cantidad * p.precio) AS total_gastado\nFROM cliente c\nJOIN pedido pp ON c.id_cliente = pp.id_cliente\nJOIN pedido_producto pdp ON pp.id_pedido = pdp.id_pedido\nJOIN producto p ON pdp.id_producto = p.id_producto\nGROUP BY c.nombre;\n\n"})}),"\n",(0,a.jsxs)(s.p,{children:["Podemos ",(0,a.jsx)(s.strong,{children:"extraer primero"})," el total de cada pedido en una subconsulta:"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"SELECT c.nombre, SUM(p.total_pedido) AS total_gastado\nFROM cliente c\nJOIN (\n    SELECT pp.id_pedido, pp.id_cliente, SUM(pdp.cantidad * p.precio) AS total_pedido\n    FROM pedido pp\n    JOIN pedido_producto pdp ON pp.id_pedido = pdp.id_pedido\n    JOIN producto p ON pdp.id_producto = p.id_producto\n    GROUP BY pp.id_pedido, pp.id_cliente\n) p ON c.id_cliente = p.id_cliente\nGROUP BY c.nombre;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Ventajas:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Separamos responsabilidades: primero calculamos totales por pedido, luego totales por cliente."}),"\n",(0,a.jsx)(s.li,{children:"M\xe1s legible y mantenible."}),"\n",(0,a.jsx)(s.li,{children:"Reutilizable con ligeros cambios."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"114-cte--common-table-expressions-with",children:"11.4. CTE \u2014 Common Table Expressions (WITH)"}),"\n",(0,a.jsxs)(s.p,{children:["Las ",(0,a.jsx)(s.strong,{children:"CTE"})," son como subconsultas, pero:"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Se escriben arriba con ",(0,a.jsx)(s.code,{children:"WITH"}),","]}),"\n",(0,a.jsx)(s.li,{children:"Pueden reutilizarse dentro de la misma consulta,"}),"\n",(0,a.jsx)(s.li,{children:"Mejoran mucho la claridad."}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo equivalente usando CTE:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"WITH totales_por_pedido AS (\n    SELECT pp.id_pedido,\n           pp.id_cliente,\n           SUM(pdp.cantidad * p.precio) AS total_pedido\n    FROM pedido pp\n    JOIN pedido_producto pdp ON pp.id_pedido = pdp.id_pedido\n    JOIN producto p ON pdp.id_producto = p.id_producto\n    GROUP BY pp.id_pedido, pp.id_cliente\n)\nSELECT c.nombre, SUM(tp.total_pedido) AS total_gastado\nFROM cliente c\nJOIN totales_por_pedido tp\n  ON c.id_cliente = tp.id_cliente\nGROUP BY c.nombre;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Ventajas sobre subconsultas:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Legibilidad clara, estructura en bloques."}),"\n",(0,a.jsx)(s.li,{children:"Reutilizable dentro de la misma consulta."}),"\n",(0,a.jsx)(s.li,{children:"F\xe1cil de debuggear (puedes ejecutar cada CTE por separado)."}),"\n"]}),"\n",(0,a.jsxs)(s.p,{children:["Las CTE ",(0,a.jsx)(s.strong,{children:"no almacenan datos"}),", son temporales y existen solo durante esa consulta."]}),"\n",(0,a.jsx)(s.h2,{id:"115-vistas--encapsulaci\xf3n-persistente",children:"11.5. Vistas \u2014 encapsulaci\xf3n persistente"}),"\n",(0,a.jsxs)(s.p,{children:["Cuando una consulta es ",(0,a.jsx)(s.strong,{children:"reutilizada frecuentemente"}),", no necesitas repetirla en cada lugar."]}),"\n",(0,a.jsxs)(s.p,{children:["La soluci\xf3n: ",(0,a.jsx)(s.strong,{children:"crear una vista"}),"."]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE VIEW totales_por_pedido AS\nSELECT pp.id_pedido,\n       pp.id_cliente,\n       SUM(pdp.cantidad * p.precio) AS total_pedido\nFROM pedido pp\nJOIN pedido_producto pdp ON pp.id_pedido = pdp.id_pedido\nJOIN producto p ON pdp.id_producto = p.id_producto\nGROUP BY pp.id_pedido, pp.id_cliente;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Ahora puedes hacer:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"SELECT c.nombre, SUM(tp.total_pedido) AS total_gastado\nFROM cliente c\nJOIN totales_por_pedido tp ON c.id_cliente = tp.id_cliente\nGROUP BY c.nombre;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Esto mejora la mantenibilidad brutalmente:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Si cambian reglas de c\xe1lculo, actualizas ",(0,a.jsx)(s.strong,{children:"una vista"}),", no todas las consultas."]}),"\n",(0,a.jsxs)(s.li,{children:["La vista ",(0,a.jsx)(s.strong,{children:"puede tener permisos"})," diferentes a la tabla original."]}),"\n",(0,a.jsx)(s.li,{children:"Se puede usar en m\xfaltiples queries, reportes y aplicaciones."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"116-vistas-vs-cte--cu\xe1ndo-usar-cada-una",children:"11.6. Vistas vs CTE \u2014 cu\xe1ndo usar cada una"}),"\n",(0,a.jsxs)(s.table,{children:[(0,a.jsx)(s.thead,{children:(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.th,{children:"CTE (WITH)"}),(0,a.jsx)(s.th,{children:"Vista (VIEW)"})]})}),(0,a.jsxs)(s.tbody,{children:[(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"Temporal, vive solo durante la consulta"}),(0,a.jsx)(s.td,{children:"Persistente en el esquema"})]}),(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"Ideal para consultas grandes puntuales"}),(0,a.jsx)(s.td,{children:"Ideal para l\xf3gica de negocio reutilizable"})]}),(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"Muy buena para debug y lectura"}),(0,a.jsx)(s.td,{children:"Muy buena para simplificar c\xf3digo repetido"})]}),(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"No afecta al esquema ni requiere permisos extra"}),(0,a.jsx)(s.td,{children:"Necesita CREATE VIEW (y permisos)"})]}),(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"\xdatil en ETL, transformaciones, reportes puntuales"}),(0,a.jsx)(s.td,{children:"\xdatil en reporting, BI, APIs, dashboards"})]})]})]}),"\n",(0,a.jsxs)(s.p,{children:["En muchos proyectos, ",(0,a.jsx)(s.strong,{children:"empiezas con una CTE"})," y si la usas varias veces, ",(0,a.jsx)(s.strong,{children:"la conviertes en vista"}),"."]}),"\n",(0,a.jsx)(s.h2,{id:"117-vistas-encadenadas--composici\xf3n-jer\xe1rquica",children:"11.7. Vistas encadenadas \u2014 composici\xf3n jer\xe1rquica"}),"\n",(0,a.jsxs)(s.p,{children:["Tambi\xe9n puedes ",(0,a.jsx)(s.strong,{children:"construir vistas sobre otras vistas"}),"."]}),"\n",(0,a.jsx)(s.p,{children:"Ejemplo:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE VIEW totales_por_cliente AS\nSELECT c.id_cliente, SUM(tp.total_pedido) AS total_gastado\nFROM cliente c\nJOIN totales_por_pedido tp ON c.id_cliente = tp.id_cliente\nGROUP BY c.id_cliente;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Y luego:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE VIEW clientes_vip AS\nSELECT id_cliente, total_gastado\nFROM totales_por_cliente\nWHERE total_gastado > 1000;\n\n"})}),"\n",(0,a.jsxs)(s.p,{children:["Con esto puedes construir un ",(0,a.jsx)(s.strong,{children:"modelo de datos en capas"}),":"]}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Vistas base: limpian y transforman datos."}),"\n",(0,a.jsx)(s.li,{children:"Vistas intermedias: agregan l\xf3gica de negocio."}),"\n",(0,a.jsx)(s.li,{children:"Vistas finales: entregan datos listos para consumir (BI, API, front)."}),"\n"]}),"\n",(0,a.jsxs)(s.p,{children:["Este patr\xf3n es muy usado en ",(0,a.jsx)(s.strong,{children:"data warehouses"})," y ",(0,a.jsx)(s.strong,{children:"modelos de negocio bien estructurados"}),"."]}),"\n",(0,a.jsx)(s.h2,{id:"118-ejemplo-pr\xe1ctico--sistema-de-biblioteca",children:"11.8. Ejemplo pr\xe1ctico \u2014 Sistema de biblioteca"}),"\n",(0,a.jsx)(s.p,{children:"Tablas:"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.code,{children:"prestamo(id_prestamo, id_socio, id_libro, fecha_inicio, estado)"})}),"\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.code,{children:"socio(id_socio, nombre)"})}),"\n",(0,a.jsx)(s.li,{children:(0,a.jsx)(s.code,{children:"libro(id_libro, titulo)"})}),"\n"]}),"\n",(0,a.jsx)(s.p,{children:"Vista base: pr\xe9stamos activos"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE VIEW prestamos_activos AS\nSELECT p.id_prestamo, p.id_socio, p.id_libro, p.fecha_inicio\nFROM prestamo p\nWHERE p.estado = 'activo';\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Vista intermedia: pr\xe9stamos activos con datos enriquecidos"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE VIEW prestamos_detalle AS\nSELECT pa.id_prestamo, s.nombre AS socio, l.titulo, pa.fecha_inicio\nFROM prestamos_activos pa\nJOIN socio s ON pa.id_socio = s.id_socio\nJOIN libro l ON pa.id_libro = l.id_libro;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Vista final: conteo de pr\xe9stamos por socio"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE VIEW prestamos_por_socio AS\nSELECT socio, COUNT(*) AS prestamos_activos\nFROM prestamos_detalle\nGROUP BY socio;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Ahora puedes:"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"SELECT * FROM prestamos_por_socio;\n\n"})}),"\n",(0,a.jsx)(s.p,{children:"Resultado:"}),"\n",(0,a.jsxs)(s.table,{children:[(0,a.jsx)(s.thead,{children:(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.th,{children:"socio"}),(0,a.jsx)(s.th,{children:"prestamos_activos"})]})}),(0,a.jsxs)(s.tbody,{children:[(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"Ana"}),(0,a.jsx)(s.td,{children:"3"})]}),(0,a.jsxs)(s.tr,{children:[(0,a.jsx)(s.td,{children:"Luis"}),(0,a.jsx)(s.td,{children:"1"})]})]})]}),"\n",(0,a.jsxs)(s.p,{children:["Tres vistas, tres niveles de responsabilidad, una consulta final ",(0,a.jsx)(s.strong,{children:"limpia y r\xe1pida"}),"."]}),"\n",(0,a.jsx)(s.h2,{id:"119-buenas-pr\xe1cticas-con-vistas-y-cte",children:"11.9. Buenas pr\xe1cticas con vistas y CTE"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsxs)(s.li,{children:["Crea vistas ",(0,a.jsx)(s.strong,{children:"con un prop\xf3sito claro"}),", no para \u201ctodo\u201d."]}),"\n",(0,a.jsxs)(s.li,{children:["Nombra las vistas con ",(0,a.jsx)(s.strong,{children:"sem\xe1ntica de negocio"}),", no t\xe9cnica (",(0,a.jsx)(s.code,{children:"ventas_por_mes"}),", no ",(0,a.jsx)(s.code,{children:"v123"}),")."]}),"\n",(0,a.jsx)(s.li,{children:"No abuses de vistas anidadas si no aportan claridad."}),"\n",(0,a.jsxs)(s.li,{children:["Documenta la ",(0,a.jsx)(s.strong,{children:"dependencia entre vistas"}),"."]}),"\n",(0,a.jsx)(s.li,{children:"Usa CTE para operaciones complejas puntuales y vistas para reglas de negocio estables."}),"\n",(0,a.jsx)(s.li,{children:"Mide el rendimiento: demasiadas vistas encadenadas pueden volverse lentas si no est\xe1n bien dise\xf1adas."}),"\n"]}),"\n",(0,a.jsx)(s.h2,{id:"errores-comunes",children:"Errores comunes"}),"\n",(0,a.jsxs)(s.ul,{children:["\n",(0,a.jsx)(s.li,{children:"Repetir l\xf3gica en m\xfaltiples queries en vez de crear una vista."}),"\n",(0,a.jsx)(s.li,{children:"Vistas sin filtros \u2192 consultas m\xe1s lentas de lo necesario."}),"\n",(0,a.jsx)(s.li,{children:"Encadenar vistas sin control \u2192 consultas dif\xedciles de depurar."}),"\n",(0,a.jsx)(s.li,{children:"No documentar cambios en las vistas \u2192 reportes inconsistentes."}),"\n",(0,a.jsx)(s.li,{children:"Usar vistas como sustituto de un buen modelo base."}),"\n"]})]})}function p(e={}){const{wrapper:s}={...(0,d.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>l});var i=n(6540);const a={},d=i.createContext(a);function o(e){const s=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(d.Provider,{value:s},e.children)}}}]);